/*! For license information please see 7112840a-dc7e191d61c8535e6f13.js.LICENSE.txt */
"use strict";(self.webpackChunkgatsby_starter_default=self.webpackChunkgatsby_starter_default||[]).push([[16],{19:function(e,t,n){n.d(t,{$q:function(){return Od},AK:function(){return cf},Ab:function(){return df},B$:function(){return ch},Bt:function(){return lf},Cf:function(){return Xl},EK:function(){return K},ET:function(){return Zd},Eo:function(){return hh},F8:function(){return Vh},Fc:function(){return Eh},GL:function(){return ef},IO:function(){return fd},IX:function(){return yh},Ix:function(){return xh},JU:function(){return lh},Jj:function(){return Ch},K9:function(){return T},Ky:function(){return Z},L$:function(){return Dh},Lx:function(){return xd},Lz:function(){return Ah},Me:function(){return Xt},Mx:function(){return Sh},PL:function(){return Gd},PU:function(){return rf},Pb:function(){return kh},QT:function(){return Bd},ST:function(){return _h},TF:function(){return Nh},TQ:function(){return Ed},UQ:function(){return jd},Ub:function(){return g},W:function(){return Pd},WA:function(){return S},Wi:function(){return Hl},Wu:function(){return Nd},Xb:function(){return Y},Xk:function(){return Kd},Xo:function(){return wd},ar:function(){return gd},at:function(){return sh},b9:function(){return Id},cf:function(){return Jd},e0:function(){return bd},fH:function(){return Th},hJ:function(){return uh},i3:function(){return uf},iE:function(){return dh},kl:function(){return $d},l7:function(){return gn},my:function(){return oh},nP:function(){return ff},oe:function(){return Yd},pl:function(){return Wd},qK:function(){return Ud},qY:function(){return vh},r7:function(){return Hd},sc:function(){return Xd},u7:function(){return Rd},vh:function(){return _d},vr:function(){return hf},xU:function(){return Fd},yq:function(){return w},zN:function(){return Qd}});var r=n(389),s=n(8463),i=n(3333),o=n(4444),a=n(5062),u=n(4489);const c="@firebase/firestore",l="4.7.7";class h{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}h.UNAUTHENTICATED=new h(null),h.GOOGLE_CREDENTIALS=new h("google-credentials-uid"),h.FIRST_PARTY=new h("first-party-uid"),h.MOCK_USER=new h("mock-user");let d="11.3.0";const f=new i.Yd("@firebase/firestore");function m(){return f.logLevel}function g(e){f.setLogLevel(e)}function p(e,...t){if(f.logLevel<=i.in.DEBUG){const n=t.map(v);f.debug(`Firestore (${d}): ${e}`,...n)}}function y(e,...t){if(f.logLevel<=i.in.ERROR){const n=t.map(v);f.error(`Firestore (${d}): ${e}`,...n)}}function w(e,...t){if(f.logLevel<=i.in.WARN){const n=t.map(v);f.warn(`Firestore (${d}): ${e}`,...n)}}function v(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function I(e="Unexpected state"){const t=`FIRESTORE (${d}) INTERNAL ASSERTION FAILED: `+e;throw y(t),new Error(t)}function _(e,t){e||I()}function T(e,t){e||I()}function b(e,t){return e}const E={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class x{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class N{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class k{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(h.UNAUTHENTICATED)))}shutdown(){}}class D{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class C{constructor(e){this.t=e,this.currentUser=h.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){_(void 0===this.o);let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new x;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new x,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{p("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),i())};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(p("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new x)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(p("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(_("string"==typeof t.accessToken),new N(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return _(null===e||"string"==typeof e),new h(e)}}class A{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=h.FIRST_PARTY,this.T=new Map}I(){return this.P?this.P():null}get headers(){this.T.set("X-Goog-AuthUser",this.l);const e=this.I();return e&&this.T.set("Authorization",e),this.h&&this.T.set("X-Goog-Iam-Authorization-Token",this.h),this.T}}class R{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new A(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(h.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class V{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e,t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null,this.V=null,(0,r._isFirebaseServerApp)(e)&&e.settings.appCheckToken&&(this.V=e.settings.appCheckToken)}start(e,t){_(void 0===this.o);const n=e=>{null!=e.error&&p("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.R;return this.R=e.token,p("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{p("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?r(e):p("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){if(this.V)return Promise.resolve(new V(this.V));const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(_("string"==typeof e.token),this.R=e.token,new V(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}function M(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}function F(){return new TextEncoder}class O{static newId(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=M(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function P(e,t){return e<t?-1:e>t?1:0}function q(e,t){const n=F().encode(e),r=F().encode(t);for(let s=0;s<Math.min(n.length,r.length);s++){const e=P(n[s],r[s]);if(0!==e)return e}return P(n.length,r.length)}function U(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function B(e){return e+"\0"}const z=-62135596800,$=1e6;class K{static now(){return K.fromMillis(Date.now())}static fromDate(e){return K.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*$);return new K(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new S(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new S(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<z)throw new S(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new S(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/$}_compareTo(e){return this.seconds===e.seconds?P(this.nanoseconds,e.nanoseconds):P(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds-z;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class G{static fromTimestamp(e){return new G(e)}static min(){return new G(new K(0,0))}static max(){return new G(new K(253402300799,999999999))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}const j="__name__";class Q{constructor(e,t,n){void 0===t?t=0:t>e.length&&I(),void 0===n?n=e.length-t:n>e.length-t&&I(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Q.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Q?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=Q.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return P(e.length,t.length)}static compareSegments(e,t){const n=Q.isNumericId(e),r=Q.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?Q.extractNumericId(e).compare(Q.extractNumericId(t)):q(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return a.z8.fromString(e.substring(4,e.length-2))}}class W extends Q{construct(e,t,n){return new W(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new S(E.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new W(t)}static emptyPath(){return new W([])}}const H=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Y extends Q{construct(e,t,n){return new Y(e,t,n)}static isValidIdentifier(e){return H.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Y.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===j}static keyField(){return new Y([j])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(E.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new S(E.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new S(E.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new S(E.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Y(t)}static emptyPath(){return new Y([])}}class Z{constructor(e){this.path=e}static fromPath(e){return new Z(W.fromString(e))}static fromName(e){return new Z(W.fromString(e).popFirst(5))}static empty(){return new Z(W.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===W.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return W.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Z(new W(e.slice()))}}const J=-1;class X{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function ee(e){return e.fields.find((e=>2===e.kind))}function te(e){return e.fields.filter((e=>2!==e.kind))}X.UNKNOWN_ID=-1;class ne{constructor(e,t){this.fieldPath=e,this.kind=t}}class re{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new re(0,oe.min())}}function se(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=G.fromTimestamp(1e9===r?new K(n+1,0):new K(n,r));return new oe(s,Z.empty(),t)}function ie(e){return new oe(e.readTime,e.key,J)}class oe{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new oe(G.min(),Z.empty(),J)}static max(){return new oe(G.max(),Z.empty(),J)}}function ae(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Z.comparator(e.documentKey,t.documentKey),0!==n?n:P(e.largestBatchId,t.largestBatchId))}const ue="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ce{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function le(e){if(e.code!==E.FAILED_PRECONDITION||e.message!==ue)throw e;p("LocalStore","Unexpectedly lost primary lease")}class he{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&I(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new he(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof he?t:he.resolve(t)}catch(e){return he.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):he.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):he.reject(t)}static resolve(e){return new he(((t,n)=>{t(e)}))}static reject(e){return new he(((t,n)=>{n(e)}))}static waitFor(e){return new he(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=he.resolve(!1);for(const n of e)t=t.next((e=>e?he.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new he(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;t(e[u]).next((e=>{i[u]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new he(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}const de="SimpleDb";class fe{static open(e,t,n,r){try{return new fe(t,e.transaction(r,n))}catch(e){throw new ye(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.m=new x,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{t.error?this.m.reject(new ye(e,t.error)):this.m.resolve()},this.transaction.onerror=t=>{const n=Te(t.target.error);this.m.reject(new ye(e,n))}}get p(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(p(de,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}S(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new ve(t)}}class me{static delete(e){return p(de,"Removing database:",e),Ie(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,o.hl)())return!1;if(me.v())return!0;const e=(0,o.z$)(),t=me.C(e),n=0<t&&t<10,r=ge(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static v(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static C(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}constructor(e,t,n){this.name=e,this.version=t,this.O=n,12.2===me.C((0,o.z$)())&&y("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async N(e){return this.db||(p(de,"Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ye(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new S(E.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(E.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ye(e,r))},r.onupgradeneeded=e=>{p(de,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.O.B(t,r.transaction,e.oldVersion,this.version).next((()=>{p(de,"Database upgrade to version "+this.version+" complete")}))}}))),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(e){this.L=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.N(e);const t=fe.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.S(),e))).catch((e=>(t.abort(e),he.reject(e)))).toPromise();return i.catch((()=>{})),await t.p,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(p(de,"Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ge(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class pe{constructor(e){this.q=e,this.$=!1,this.U=null}get isDone(){return this.$}get K(){return this.U}set cursor(e){this.q=e}done(){this.$=!0}W(e){this.U=e}delete(){return Ie(this.q.delete())}}class ye extends S{constructor(e,t){super(E.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function we(e){return"IndexedDbTransactionError"===e.name}class ve{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(p(de,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(p(de,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),Ie(n)}add(e){return p(de,"ADD",this.store.name,e,e),Ie(this.store.add(e))}get(e){return Ie(this.store.get(e)).next((t=>(void 0===t&&(t=null),p(de,"GET",this.store.name,e,t),t)))}delete(e){return p(de,"DELETE",this.store.name,e),Ie(this.store.delete(e))}count(){return p(de,"COUNT",this.store.name),Ie(this.store.count())}G(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new he(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}{const e=this.cursor(n),t=[];return this.j(e,((e,n)=>{t.push(n)})).next((()=>t))}}H(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new he(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}J(e,t){p(de,"DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;const r=this.cursor(n);return this.j(r,((e,t,n)=>n.delete()))}Z(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.j(r,t)}X(e){const t=this.cursor({});return new he(((n,r)=>{t.onerror=e=>{const t=Te(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}j(e,t){const n=[];return new he(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new pe(s),o=t(s.primaryKey,s.value,i);if(o instanceof he){const e=o.catch((e=>(i.done(),he.reject(e))));n.push(e)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}})).next((()=>he.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Ie(e){return new he(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=Te(e.target.error);n(t)}}))}let _e=!1;function Te(e){const t=me.C((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return _e||(_e=!0,setTimeout((()=>{throw e}),0)),e}}return e}const be="IndexBackfiller";class Ee{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){p(be,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{const e=await this.ee.ne();p(be,`Documents written: ${e}`)}catch(e){we(e)?p(be,"Ignoring IndexedDB error during index backfill: ",e):await le(e)}await this.te(6e4)}))}}class Se{constructor(e,t){this.localStore=e,this.persistence=t}async ne(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.re(t,e)))}re(e,t){const n=new Set;let r=t,s=!0;return he.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return p(be,`Processing collection: ${t}`),this.ie(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}ie(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.se(r,n))).next((n=>(p(be,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}se(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=ie(t);ae(r,n)>0&&(n=r)})),new oe(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class xe{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this._e&&this._e(e),e}}xe.ae=-1;const Ne=-1;function ke(e){return null==e}function De(e){return 0===e&&1/e==-1/0}function Ce(e){return"number"==typeof e&&Number.isInteger(e)&&!De(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const Ae="";function Re(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Le(t)),t=Ve(e.get(n),t);return Le(t)}function Ve(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="";break;case Ae:n+="";break;default:n+=t}}return n}function Le(e){return e+Ae+""}function Me(e){const t=e.length;if(_(t>=2),2===t)return _(e.charAt(0)===Ae&&""===e.charAt(1)),W.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf(Ae,i);switch((t<0||t>n)&&I(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=e.substring(i,t),s+="\0";break;case"":s+=e.substring(i,t+1);break;default:I()}i=t+2}return new W(r)}const Fe="remoteDocuments",Oe="owner",Pe="owner",qe="mutationQueues",Ue="mutations",Be="batchId",ze="userMutationsIndex",$e=["userId","batchId"];function Ke(e,t){return[e,Re(t)]}function Ge(e,t,n){return[e,Re(t),n]}const je={},Qe="documentMutations",We="remoteDocumentsV14",He=["prefixPath","collectionGroup","readTime","documentId"],Ye="documentKeyIndex",Ze=["prefixPath","collectionGroup","documentId"],Je="collectionGroupIndex",Xe=["collectionGroup","readTime","prefixPath","documentId"],et="remoteDocumentGlobal",tt="remoteDocumentGlobalKey",nt="targets",rt="queryTargetsIndex",st=["canonicalId","targetId"],it="targetDocuments",ot=["targetId","path"],at="documentTargetsIndex",ut=["path","targetId"],ct="targetGlobalKey",lt="targetGlobal",ht="collectionParents",dt=["collectionId","parent"],ft="clientMetadata",mt="bundles",gt="namedQueries",pt="indexConfiguration",yt="collectionGroupIndex",wt="indexState",vt=["indexId","uid"],It="sequenceNumberIndex",_t=["uid","sequenceNumber"],Tt="indexEntries",bt=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Et="documentKeyIndex",St=["indexId","uid","orderedDocumentKey"],xt="documentOverlays",Nt=["userId","collectionPath","documentId"],kt="collectionPathOverlayIndex",Dt=["userId","collectionPath","largestBatchId"],Ct="collectionGroupOverlayIndex",At=["userId","collectionGroup","largestBatchId"],Rt="globals",Vt=[qe,Ue,Qe,Fe,nt,Oe,lt,it,ft,et,ht,mt,gt],Lt=[...Vt,xt],Mt=[qe,Ue,Qe,We,nt,Oe,lt,it,ft,et,ht,mt,gt,xt],Ft=Mt,Ot=[...Ft,pt,wt,Tt],Pt=Ot,qt=[...Ot,Rt];class Ut extends ce{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function Bt(e,t){const n=b(e);return me.M(n.ue,t)}function zt(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function $t(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Kt(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Gt{constructor(e,t){this.comparator=e,this.root=t||Qt.EMPTY}insert(e,t){return new Gt(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Qt.BLACK,null,null))}remove(e){return new Gt(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Qt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new jt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new jt(this.root,e,this.comparator,!1)}getReverseIterator(){return new jt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new jt(this.root,e,this.comparator,!0)}}class jt{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Qt{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Qt.RED,this.left=null!=r?r:Qt.EMPTY,this.right=null!=s?s:Qt.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Qt(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Qt.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Qt.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Qt.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Qt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw I();if(this.right.isRed())throw I();const e=this.left.check();if(e!==this.right.check())throw I();return e+(this.isRed()?0:1)}}Qt.EMPTY=null,Qt.RED=!0,Qt.BLACK=!1,Qt.EMPTY=new class{constructor(){this.size=0}get key(){throw I()}get value(){throw I()}get color(){throw I()}get left(){throw I()}get right(){throw I()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Qt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Wt{constructor(e){this.comparator=e,this.data=new Gt(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Ht(this.data.getIterator())}getIteratorFrom(e){return new Ht(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Wt))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Wt(this.comparator);return t.data=e,t}}class Ht{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Yt(e){return e.hasNext()?e.getNext():void 0}class Zt{constructor(e){this.fields=e,e.sort(Y.comparator)}static empty(){return new Zt([])}unionWith(e){let t=new Wt(Y.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new Zt(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return U(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Jt extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function Xt(){return"undefined"!=typeof atob}class en{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new Jt("Invalid base64 string: "+e):e}}(e);return new en(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new en(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return P(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}en.EMPTY_BYTE_STRING=new en("");const tn=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function nn(e){if(_(!!e),"string"==typeof e){let t=0;const n=tn.exec(e);if(_(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:rn(e.seconds),nanos:rn(e.nanos)}}function rn(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function sn(e){return"string"==typeof e?en.fromBase64String(e):en.fromUint8Array(e)}const on="server_timestamp",an="__type__",un="__previous_value__",cn="__local_write_time__";function ln(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[an])||void 0===n?void 0:n.stringValue)===on}function hn(e){const t=e.mapValue.fields[un];return ln(t)?hn(t):t}function dn(e){const t=nn(e.mapValue.fields[cn].timestampValue);return new K(t.seconds,t.nanos)}class fn{constructor(e,t,n,r,s,i,o,a,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}const mn="(default)";class gn{constructor(e,t){this.projectId=e,this.database=t||mn}static empty(){return new gn("","")}get isDefaultDatabase(){return this.database===mn}isEqual(e){return e instanceof gn&&e.projectId===this.projectId&&e.database===this.database}}const pn="__type__",yn="__max__",wn={mapValue:{fields:{__type__:{stringValue:yn}}}},vn="__vector__",In="value",_n={nullValue:"NULL_VALUE"};function Tn(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ln(e)?4:qn(e)?9007199254740991:On(e)?10:11:I()}function bn(e,t){if(e===t)return!0;const n=Tn(e);if(n!==Tn(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return dn(e).isEqual(dn(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=nn(e.timestampValue),r=nn(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return sn(e.bytesValue).isEqual(sn(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return rn(e.geoPointValue.latitude)===rn(t.geoPointValue.latitude)&&rn(e.geoPointValue.longitude)===rn(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return rn(e.integerValue)===rn(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=rn(e.doubleValue),r=rn(t.doubleValue);return n===r?De(n)===De(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return U(e.arrayValue.values||[],t.arrayValue.values||[],bn);case 10:case 11:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(zt(n)!==zt(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!bn(n[s],r[s])))return!1;return!0}(e,t);default:return I()}}function En(e,t){return void 0!==(e.values||[]).find((e=>bn(e,t)))}function Sn(e,t){if(e===t)return 0;const n=Tn(e),r=Tn(t);if(n!==r)return P(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return P(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=rn(e.integerValue||e.doubleValue),r=rn(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return xn(e.timestampValue,t.timestampValue);case 4:return xn(dn(e),dn(t));case 5:return q(e.stringValue,t.stringValue);case 6:return function(e,t){const n=sn(e),r=sn(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=P(n[s],r[s]);if(0!==e)return e}return P(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=P(rn(e.latitude),rn(t.latitude));return 0!==n?n:P(rn(e.longitude),rn(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return Nn(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,s,i;const o=e.fields||{},a=t.fields||{},u=null===(n=o[In])||void 0===n?void 0:n.arrayValue,c=null===(r=a[In])||void 0===r?void 0:r.arrayValue,l=P((null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0,(null===(i=null==c?void 0:c.values)||void 0===i?void 0:i.length)||0);return 0!==l?l:Nn(u,c)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===wn.mapValue&&t===wn.mapValue)return 0;if(e===wn.mapValue)return 1;if(t===wn.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=q(r[o],i[o]);if(0!==e)return e;const t=Sn(n[r[o]],s[i[o]]);if(0!==t)return t}return P(r.length,i.length)}(e.mapValue,t.mapValue);default:throw I()}}function xn(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return P(e,t);const n=nn(e),r=nn(t),s=P(n.seconds,r.seconds);return 0!==s?s:P(n.nanos,r.nanos)}function Nn(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=Sn(n[s],r[s]);if(e)return e}return P(n.length,r.length)}function kn(e){return Dn(e)}function Dn(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=nn(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return sn(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return Z.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Dn(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${Dn(e.fields[s])}`;return n+"}"}(e.mapValue):I()}function Cn(e){switch(Tn(e)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=hn(e);return t?16+Cn(t):16;case 5:return 2*e.stringValue.length;case 6:return sn(e.bytesValue).approximateByteSize();case 7:return e.referenceValue.length;case 9:return function(e){return(e.values||[]).reduce(((e,t)=>e+Cn(t)),0)}(e.arrayValue);case 10:case 11:return function(e){let t=0;return $t(e.fields,((e,n)=>{t+=e.length+Cn(n)})),t}(e.mapValue);default:throw I()}}function An(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Rn(e){return!!e&&"integerValue"in e}function Vn(e){return!!e&&"arrayValue"in e}function Ln(e){return!!e&&"nullValue"in e}function Mn(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Fn(e){return!!e&&"mapValue"in e}function On(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[pn])||void 0===n?void 0:n.stringValue)===vn}function Pn(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return $t(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Pn(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Pn(e.arrayValue.values[n]);return t}return Object.assign({},e)}function qn(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===yn}const Un={mapValue:{fields:{[pn]:{stringValue:vn},[In]:{arrayValue:{}}}}};function Bn(e){return"nullValue"in e?_n:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?An(gn.empty(),Z.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?On(e)?Un:{mapValue:{}}:I()}function zn(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?An(gn.empty(),Z.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?Un:"mapValue"in e?On(e)?{mapValue:{}}:wn:I()}function $n(e,t){const n=Sn(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Kn(e,t){const n=Sn(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Gn{constructor(e){this.value=e}static empty(){return new Gn({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Fn(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Pn(t)}setAll(e){let t=Y.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=Pn(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());Fn(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return bn(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Fn(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){$t(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new Gn(Pn(this.value))}}function jn(e){const t=[];return $t(e.fields,((e,n)=>{const r=new Y([e]);if(Fn(n)){const e=jn(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new Zt(t)}class Qn{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new Qn(e,0,G.min(),G.min(),G.min(),Gn.empty(),0)}static newFoundDocument(e,t,n,r){return new Qn(e,1,t,G.min(),n,r,0)}static newNoDocument(e,t){return new Qn(e,2,t,G.min(),G.min(),Gn.empty(),0)}static newUnknownDocument(e,t){return new Qn(e,3,t,G.min(),G.min(),Gn.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(G.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Gn.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Gn.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=G.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Qn&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Qn(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Wn{constructor(e,t){this.position=e,this.inclusive=t}}function Hn(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?Z.comparator(Z.fromName(o.referenceValue),n.key):Sn(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Yn(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!bn(e.position[n],t.position[n]))return!1;return!0}class Zn{constructor(e,t="asc"){this.field=e,this.dir=t}}function Jn(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Xn{}class er extends Xn{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new lr(e,t,n):"array-contains"===t?new mr(e,n):"in"===t?new gr(e,n):"not-in"===t?new pr(e,n):"array-contains-any"===t?new yr(e,n):new er(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new hr(e,n):new dr(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Sn(t,this.value)):null!==t&&Tn(this.value)===Tn(t)&&this.matchesComparison(Sn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return I()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class tr extends Xn{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new tr(e,t)}matches(e){return nr(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ce}getFilters(){return Object.assign([],this.filters)}}function nr(e){return"and"===e.op}function rr(e){return"or"===e.op}function sr(e){return ir(e)&&nr(e)}function ir(e){for(const t of e.filters)if(t instanceof tr)return!1;return!0}function or(e){if(e instanceof er)return e.field.canonicalString()+e.op.toString()+kn(e.value);if(sr(e))return e.filters.map((e=>or(e))).join(",");{const t=e.filters.map((e=>or(e))).join(",");return`${e.op}(${t})`}}function ar(e,t){return e instanceof er?function(e,t){return t instanceof er&&e.op===t.op&&e.field.isEqual(t.field)&&bn(e.value,t.value)}(e,t):e instanceof tr?function(e,t){return t instanceof tr&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&ar(n,t.filters[r])),!0)}(e,t):void I()}function ur(e,t){const n=e.filters.concat(t);return tr.create(n,e.op)}function cr(e){return e instanceof er?function(e){return`${e.field.canonicalString()} ${e.op} ${kn(e.value)}`}(e):e instanceof tr?function(e){return e.op.toString()+" {"+e.getFilters().map(cr).join(" ,")+"}"}(e):"Filter"}class lr extends er{constructor(e,t,n){super(e,t,n),this.key=Z.fromName(n.referenceValue)}matches(e){const t=Z.comparator(e.key,this.key);return this.matchesComparison(t)}}class hr extends er{constructor(e,t){super(e,"in",t),this.keys=fr("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class dr extends er{constructor(e,t){super(e,"not-in",t),this.keys=fr("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function fr(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>Z.fromName(e.referenceValue)))}class mr extends er{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Vn(t)&&En(t.arrayValue,this.value)}}class gr extends er{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&En(this.value.arrayValue,t)}}class pr extends er{constructor(e,t){super(e,"not-in",t)}matches(e){if(En(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!En(this.value.arrayValue,t)}}class yr extends er{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Vn(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>En(this.value.arrayValue,e)))}}class wr{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.le=null}}function vr(e,t=null,n=[],r=[],s=null,i=null,o=null){return new wr(e,t,n,r,s,i,o)}function Ir(e){const t=b(e);if(null===t.le){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>or(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),ke(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>kn(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>kn(e))).join(",")),t.le=e}return t.le}function _r(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Jn(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!ar(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Yn(e.startAt,t.startAt)&&Yn(e.endAt,t.endAt)}function Tr(e){return Z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function br(e,t){return e.filters.filter((e=>e instanceof er&&e.field.isEqual(t)))}function Er(e,t,n){let r=_n,s=!0;for(const i of br(e,t)){let e=_n,t=!0;switch(i.op){case"<":case"<=":e=Bn(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=_n}$n({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];$n({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function Sr(e,t,n){let r=wn,s=!0;for(const i of br(e,t)){let e=wn,t=!0;switch(i.op){case">=":case">":e=zn(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=wn}Kn({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Kn({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class xr{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.he=null,this.Pe=null,this.Te=null,this.startAt,this.endAt}}function Nr(e,t,n,r,s,i,o,a){return new xr(e,t,n,r,s,i,o,a)}function kr(e){return new xr(e)}function Dr(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Cr(e){return null!==e.collectionGroup}function Ar(e){const t=b(e);if(null===t.he){t.he=[];const e=new Set;for(const s of t.explicitOrderBy)t.he.push(s),e.add(s.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new Wt(Y.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);r.forEach((r=>{e.has(r.canonicalString())||r.isKeyField()||t.he.push(new Zn(r,n))})),e.has(Y.keyField().canonicalString())||t.he.push(new Zn(Y.keyField(),n))}return t.he}function Rr(e){const t=b(e);return t.Pe||(t.Pe=Vr(t,Ar(e))),t.Pe}function Vr(e,t){if("F"===e.limitType)return vr(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map((e=>{const t="desc"===e.dir?"asc":"desc";return new Zn(e.field,t)}));const n=e.endAt?new Wn(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Wn(e.startAt.position,e.startAt.inclusive):null;return vr(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function Lr(e,t){const n=e.filters.concat([t]);return new xr(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Mr(e,t,n){return new xr(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Fr(e,t){return _r(Rr(e),Rr(t))&&e.limitType===t.limitType}function Or(e){return`${Ir(Rr(e))}|lt:${e.limitType}`}function Pr(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>cr(e))).join(", ")}]`),ke(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>kn(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>kn(e))).join(",")),`Target(${t})`}(Rr(e))}; limitType=${e.limitType})`}function qr(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Z.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Ar(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Hn(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Ar(e),t))&&!(e.endAt&&!function(e,t,n){const r=Hn(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Ar(e),t))}(e,t)}function Ur(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Br(e){return(t,n)=>{let r=!1;for(const s of Ar(e)){const e=zr(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function zr(e,t,n){const r=e.field.isKeyField()?Z.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?Sn(r,s):I()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return I()}}class $r{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){$t(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return Kt(this.inner)}size(){return this.innerSize}}const Kr=new Gt(Z.comparator);function Gr(){return Kr}const jr=new Gt(Z.comparator);function Qr(...e){let t=jr;for(const n of e)t=t.insert(n.key,n);return t}function Wr(e){let t=jr;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Hr(){return Zr()}function Yr(){return Zr()}function Zr(){return new $r((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Jr=new Gt(Z.comparator),Xr=new Wt(Z.comparator);function es(...e){let t=Xr;for(const n of e)t=t.add(n);return t}const ts=new Wt(P);function ns(){return ts}function rs(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:De(t)?"-0":t}}function ss(e){return{integerValue:""+e}}function is(e,t){return Ce(t)?ss(t):rs(e,t)}class os{constructor(){this._=void 0}}function as(e,t,n){return e instanceof ls?function(e,t){const n={fields:{[an]:{stringValue:on},[cn]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&ln(t)&&(t=hn(t)),t&&(n.fields[un]=t),{mapValue:n}}(n,t):e instanceof hs?ds(e,t):e instanceof fs?ms(e,t):function(e,t){const n=cs(e,t),r=ps(n)+ps(e.Ie);return Rn(n)&&Rn(e.Ie)?ss(r):rs(e.serializer,r)}(e,t)}function us(e,t,n){return e instanceof hs?ds(e,t):e instanceof fs?ms(e,t):n}function cs(e,t){return e instanceof gs?function(e){return Rn(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class ls extends os{}class hs extends os{constructor(e){super(),this.elements=e}}function ds(e,t){const n=ys(t);for(const r of e.elements)n.some((e=>bn(e,r)))||n.push(r);return{arrayValue:{values:n}}}class fs extends os{constructor(e){super(),this.elements=e}}function ms(e,t){let n=ys(t);for(const r of e.elements)n=n.filter((e=>!bn(e,r)));return{arrayValue:{values:n}}}class gs extends os{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function ps(e){return rn(e.integerValue||e.doubleValue)}function ys(e){return Vn(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class ws{constructor(e,t){this.field=e,this.transform=t}}class vs{constructor(e,t){this.version=e,this.transformResults=t}}class Is{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Is}static exists(e){return new Is(void 0,e)}static updateTime(e){return new Is(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function _s(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Ts{}function bs(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Vs(e.key,Is.none()):new ks(e.key,e.data,Is.none());{const n=e.data,r=Gn.empty();let s=new Wt(Y.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new Ds(e.key,r,new Zt(s.toArray()),Is.none())}}function Es(e,t,n){e instanceof ks?function(e,t,n){const r=e.value.clone(),s=As(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Ds?function(e,t,n){if(!_s(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=As(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Cs(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Ss(e,t,n,r){return e instanceof ks?function(e,t,n,r){if(!_s(e.precondition,t))return n;const s=e.value.clone(),i=Rs(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof Ds?function(e,t,n,r){if(!_s(e.precondition,t))return n;const s=Rs(e.fieldTransforms,r,t),i=t.data;return i.setAll(Cs(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return _s(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function xs(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=cs(r.transform,e||null);null!=s&&(null===n&&(n=Gn.empty()),n.set(r.field,s))}return n||null}function Ns(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&U(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof hs&&t instanceof hs||e instanceof fs&&t instanceof fs?U(e.elements,t.elements,bn):e instanceof gs&&t instanceof gs?bn(e.Ie,t.Ie):e instanceof ls&&t instanceof ls}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class ks extends Ts{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Ds extends Ts{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Cs(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function As(e,t,n){const r=new Map;_(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,us(o,a,n[s]))}return r}function Rs(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,as(e,i,t))}return r}class Vs extends Ts{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ls extends Ts{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Ms{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&Es(t,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Ss(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Ss(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Yr();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=bs(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(G.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),es())}isEqual(e){return this.batchId===e.batchId&&U(this.mutations,e.mutations,((e,t)=>Ns(e,t)))&&U(this.baseMutations,e.baseMutations,((e,t)=>Ns(e,t)))}}class Fs{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){_(e.mutations.length===n.length);let r=Jr;const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Fs(e,t,n,r)}}class Os{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Ps{constructor(e,t){this.count=e,this.unchangedNames=t}}var qs,Us;function Bs(e){switch(e){case E.OK:return I();case E.CANCELLED:case E.UNKNOWN:case E.DEADLINE_EXCEEDED:case E.RESOURCE_EXHAUSTED:case E.INTERNAL:case E.UNAVAILABLE:case E.UNAUTHENTICATED:return!1;case E.INVALID_ARGUMENT:case E.NOT_FOUND:case E.ALREADY_EXISTS:case E.PERMISSION_DENIED:case E.FAILED_PRECONDITION:case E.ABORTED:case E.OUT_OF_RANGE:case E.UNIMPLEMENTED:case E.DATA_LOSS:return!0;default:return I()}}function zs(e){if(void 0===e)return y("GRPC error has no .code"),E.UNKNOWN;switch(e){case qs.OK:return E.OK;case qs.CANCELLED:return E.CANCELLED;case qs.UNKNOWN:return E.UNKNOWN;case qs.DEADLINE_EXCEEDED:return E.DEADLINE_EXCEEDED;case qs.RESOURCE_EXHAUSTED:return E.RESOURCE_EXHAUSTED;case qs.INTERNAL:return E.INTERNAL;case qs.UNAVAILABLE:return E.UNAVAILABLE;case qs.UNAUTHENTICATED:return E.UNAUTHENTICATED;case qs.INVALID_ARGUMENT:return E.INVALID_ARGUMENT;case qs.NOT_FOUND:return E.NOT_FOUND;case qs.ALREADY_EXISTS:return E.ALREADY_EXISTS;case qs.PERMISSION_DENIED:return E.PERMISSION_DENIED;case qs.FAILED_PRECONDITION:return E.FAILED_PRECONDITION;case qs.ABORTED:return E.ABORTED;case qs.OUT_OF_RANGE:return E.OUT_OF_RANGE;case qs.UNIMPLEMENTED:return E.UNIMPLEMENTED;case qs.DATA_LOSS:return E.DATA_LOSS;default:return I()}}(Us=qs||(qs={}))[Us.OK=0]="OK",Us[Us.CANCELLED=1]="CANCELLED",Us[Us.UNKNOWN=2]="UNKNOWN",Us[Us.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Us[Us.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Us[Us.NOT_FOUND=5]="NOT_FOUND",Us[Us.ALREADY_EXISTS=6]="ALREADY_EXISTS",Us[Us.PERMISSION_DENIED=7]="PERMISSION_DENIED",Us[Us.UNAUTHENTICATED=16]="UNAUTHENTICATED",Us[Us.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Us[Us.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Us[Us.ABORTED=10]="ABORTED",Us[Us.OUT_OF_RANGE=11]="OUT_OF_RANGE",Us[Us.UNIMPLEMENTED=12]="UNIMPLEMENTED",Us[Us.INTERNAL=13]="INTERNAL",Us[Us.UNAVAILABLE=14]="UNAVAILABLE",Us[Us.DATA_LOSS=15]="DATA_LOSS";let $s=null;const Ks=new a.z8([4294967295,4294967295],0);function Gs(e){const t=F().encode(e),n=new a.V8;return n.update(t),new Uint8Array(n.digest())}function js(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.z8([n,r],0),new a.z8([s,i],0)]}class Qs{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Ws(`Invalid padding: ${t}`);if(n<0)throw new Ws(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Ws(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Ws(`Invalid padding when bitmap length is 0: ${t}`);this.Ee=8*e.length-t,this.de=a.z8.fromNumber(this.Ee)}Ae(e,t,n){let r=e.add(t.multiply(a.z8.fromNumber(n)));return 1===r.compare(Ks)&&(r=new a.z8([r.getBits(0),r.getBits(1)],0)),r.modulo(this.de).toNumber()}Re(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ee)return!1;const t=Gs(e),[n,r]=js(t);for(let s=0;s<this.hashCount;s++){const e=this.Ae(n,r,s);if(!this.Re(e))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new Qs(s,r,t);return n.forEach((e=>i.insert(e))),i}insert(e){if(0===this.Ee)return;const t=Gs(e),[n,r]=js(t);for(let s=0;s<this.hashCount;s++){const e=this.Ae(n,r,s);this.Ve(e)}}Ve(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Ws extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Hs{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Ys.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Hs(G.min(),r,new Gt(P),Gr(),es())}}class Ys{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Ys(n,t,es(),es(),es())}}class Zs{constructor(e,t,n,r){this.me=e,this.removedTargetIds=t,this.key=n,this.fe=r}}class Js{constructor(e,t){this.targetId=e,this.ge=t}}class Xs{constructor(e,t,n=en.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class ei{constructor(){this.pe=0,this.ye=ri(),this.we=en.EMPTY_BYTE_STRING,this.Se=!1,this.be=!0}get current(){return this.Se}get resumeToken(){return this.we}get De(){return 0!==this.pe}get ve(){return this.be}Ce(e){e.approximateByteSize()>0&&(this.be=!0,this.we=e)}Fe(){let e=es(),t=es(),n=es();return this.ye.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:I()}})),new Ys(this.we,this.Se,e,t,n)}Me(){this.be=!1,this.ye=ri()}xe(e,t){this.be=!0,this.ye=this.ye.insert(e,t)}Oe(e){this.be=!0,this.ye=this.ye.remove(e)}Ne(){this.pe+=1}Be(){this.pe-=1,_(this.pe>=0)}Le(){this.be=!0,this.Se=!0}}class ti{constructor(e){this.ke=e,this.qe=new Map,this.Qe=Gr(),this.$e=ni(),this.Ue=ni(),this.Ke=new Gt(P)}We(e){for(const t of e.me)e.fe&&e.fe.isFoundDocument()?this.Ge(t,e.fe):this.ze(t,e.key,e.fe);for(const t of e.removedTargetIds)this.ze(t,e.key,e.fe)}je(e){this.forEachTarget(e,(t=>{const n=this.He(t);switch(e.state){case 0:this.Je(t)&&n.Ce(e.resumeToken);break;case 1:n.Be(),n.De||n.Me(),n.Ce(e.resumeToken);break;case 2:n.Be(),n.De||this.removeTarget(t);break;case 3:this.Je(t)&&(n.Le(),n.Ce(e.resumeToken));break;case 4:this.Je(t)&&(this.Ye(t),n.Ce(e.resumeToken));break;default:I()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.qe.forEach(((e,n)=>{this.Je(n)&&t(n)}))}Ze(e){const t=e.targetId,n=e.ge.count,r=this.Xe(t);if(r){const s=r.target;if(Tr(s))if(0===n){const e=new Z(s.path);this.ze(t,e,Qn.newNoDocument(e,G.min()))}else _(1===n);else{const r=this.et(t);if(r!==n){const n=this.tt(e),s=n?this.nt(n,e,r):1;if(0!==s){this.Ye(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(t,e)}null==$s||$s.rt(function(e,t,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:e=>{var t;return null!==(t=null==r?void 0:r.mightContain(e))&&void 0!==t&&t}}),h}(r,e.ge,this.ke.it(),n,s))}}}}tt(e){const t=e.ge.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=t;let i,o;try{i=sn(n).toUint8Array()}catch(e){if(e instanceof Jt)return w("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{o=new Qs(i,r,s)}catch(e){return w(e instanceof Ws?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===o.Ee?null:o}nt(e,t,n){return t.ge.count===n-this.st(e,t.targetId)?0:2}st(e,t){const n=this.ke.getRemoteKeysForTarget(t);let r=0;return n.forEach((n=>{const s=this.ke.it(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.ze(t,n,null),r++)})),r}ot(e){const t=new Map;this.qe.forEach(((n,r)=>{const s=this.Xe(r);if(s){if(n.current&&Tr(s.target)){const t=new Z(s.target.path);this._t(t).has(r)||this.ut(r,t)||this.ze(r,t,Qn.newNoDocument(t,e))}n.ve&&(t.set(r,n.Fe()),n.Me())}}));let n=es();this.Ue.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Xe(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.Qe.forEach(((t,n)=>n.setReadTime(e)));const r=new Hs(e,t,this.Ke,this.Qe,n);return this.Qe=Gr(),this.$e=ni(),this.Ue=ni(),this.Ke=new Gt(P),r}Ge(e,t){if(!this.Je(e))return;const n=this.ut(e,t.key)?2:0;this.He(e).xe(t.key,n),this.Qe=this.Qe.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)),this.Ue=this.Ue.insert(t.key,this.ct(t.key).add(e))}ze(e,t,n){if(!this.Je(e))return;const r=this.He(e);this.ut(e,t)?r.xe(t,1):r.Oe(t),this.Ue=this.Ue.insert(t,this.ct(t).delete(e)),this.Ue=this.Ue.insert(t,this.ct(t).add(e)),n&&(this.Qe=this.Qe.insert(t,n))}removeTarget(e){this.qe.delete(e)}et(e){const t=this.He(e).Fe();return this.ke.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ne(e){this.He(e).Ne()}He(e){let t=this.qe.get(e);return t||(t=new ei,this.qe.set(e,t)),t}ct(e){let t=this.Ue.get(e);return t||(t=new Wt(P),this.Ue=this.Ue.insert(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new Wt(P),this.$e=this.$e.insert(e,t)),t}Je(e){const t=null!==this.Xe(e);return t||p("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){const t=this.qe.get(e);return t&&t.De?null:this.ke.lt(e)}Ye(e){this.qe.set(e,new ei),this.ke.getRemoteKeysForTarget(e).forEach((t=>{this.ze(e,t,null)}))}ut(e,t){return this.ke.getRemoteKeysForTarget(e).has(t)}}function ni(){return new Gt(Z.comparator)}function ri(){return new Gt(Z.comparator)}const si={asc:"ASCENDING",desc:"DESCENDING"},ii={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},oi={and:"AND",or:"OR"};class ai{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ui(e,t){return e.useProto3Json||ke(t)?t:{value:t}}function ci(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function li(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function hi(e,t){return ci(e,t.toTimestamp())}function di(e){return _(!!e),G.fromTimestamp(function(e){const t=nn(e);return new K(t.seconds,t.nanos)}(e))}function fi(e,t){return mi(e,t).canonicalString()}function mi(e,t){const n=function(e){return new W(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function gi(e){const t=W.fromString(e);return _(Oi(t)),t}function pi(e,t){return fi(e.databaseId,t.path)}function yi(e,t){const n=gi(t);if(n.get(1)!==e.databaseId.projectId)throw new S(E.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new S(E.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Z(_i(n))}function wi(e,t){return fi(e.databaseId,t)}function vi(e){const t=gi(e);return 4===t.length?W.emptyPath():_i(t)}function Ii(e){return new W(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function _i(e){return _(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function Ti(e,t,n){return{name:pi(e,t),fields:n.value.mapValue.fields}}function bi(e,t,n){const r=yi(e,t.name),s=di(t.updateTime),i=t.createTime?di(t.createTime):G.min(),o=new Gn({mapValue:{fields:t.fields}}),a=Qn.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Ei(e,t){let n;if(t instanceof ks)n={update:Ti(e,t.key,t.value)};else if(t instanceof Vs)n={delete:pi(e,t.key)};else if(t instanceof Ds)n={update:Ti(e,t.key,t.data),updateMask:Fi(t.fieldMask)};else{if(!(t instanceof Ls))return I();n={verify:pi(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof ls)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof hs)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof fs)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof gs)return{fieldPath:t.field.canonicalString(),increment:n.Ie};throw I()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:hi(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:I()}(e,t.precondition)),n}function Si(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?Is.updateTime(di(e.updateTime)):void 0!==e.exists?Is.exists(e.exists):Is.none()}(t.currentDocument):Is.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)_("REQUEST_TIME"===t.setToServerValue),n=new ls;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new hs(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new fs(e)}else"increment"in t?n=new gs(e,t.increment):I();const r=Y.fromServerFormat(t.fieldPath);return new ws(r,n)}(e,t))):[];if(t.update){t.update.name;const s=yi(e,t.update.name),i=new Gn({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new Zt(t.map((e=>Y.fromServerFormat(e))))}(t.updateMask);return new Ds(s,i,e,n,r)}return new ks(s,i,n,r)}if(t.delete){const r=yi(e,t.delete);return new Vs(r,n)}if(t.verify){const r=yi(e,t.verify);return new Ls(r,n)}return I()}function xi(e,t){return{documents:[wi(e,t.path)]}}function Ni(e,t){const n={structuredQuery:{}},r=t.path;let s;null!==t.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=wi(e,s);const i=function(e){if(0!==e.length)return Mi(tr.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const o=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Vi(e.field),direction:Ci(e.dir)}}(e)))}(t.orderBy);o&&(n.structuredQuery.orderBy=o);const a=ui(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{ht:n,parent:s}}function ki(e){let t=vi(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){_(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=Di(e);return t instanceof tr&&sr(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=function(e){return e.map((e=>function(e){return new Zn(Li(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)))}(n.orderBy));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,ke(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new Wn(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new Wn(n,t)}(n.endAt)),Nr(t,s,o,i,a,"F",u,c)}function Di(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Li(e.unaryFilter.field);return er.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Li(e.unaryFilter.field);return er.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Li(e.unaryFilter.field);return er.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Li(e.unaryFilter.field);return er.create(s,"!=",{nullValue:"NULL_VALUE"});default:return I()}}(e):void 0!==e.fieldFilter?function(e){return er.create(Li(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return I()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return tr.create(e.compositeFilter.filters.map((e=>Di(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return I()}}(e.compositeFilter.op))}(e):I()}function Ci(e){return si[e]}function Ai(e){return ii[e]}function Ri(e){return oi[e]}function Vi(e){return{fieldPath:e.canonicalString()}}function Li(e){return Y.fromServerFormat(e.fieldPath)}function Mi(e){return e instanceof er?function(e){if("=="===e.op){if(Mn(e.value))return{unaryFilter:{field:Vi(e.field),op:"IS_NAN"}};if(Ln(e.value))return{unaryFilter:{field:Vi(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Mn(e.value))return{unaryFilter:{field:Vi(e.field),op:"IS_NOT_NAN"}};if(Ln(e.value))return{unaryFilter:{field:Vi(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Vi(e.field),op:Ai(e.op),value:e.value}}}(e):e instanceof tr?function(e){const t=e.getFilters().map((e=>Mi(e)));return 1===t.length?t[0]:{compositeFilter:{op:Ri(e.op),filters:t}}}(e):I()}function Fi(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Oi(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Pi{constructor(e,t,n,r,s=G.min(),i=G.min(),o=en.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new Pi(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Pi(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Pi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Pi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class qi{constructor(e){this.Tt=e}}function Ui(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Bi(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:pi(e,t.key),fields:t.data.value.mapValue.fields,updateTime:ci(e,t.version.toTimestamp()),createTime:ci(e,t.createTime.toTimestamp())}}(e.Tt,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:zi(t.version)};else{if(!t.isUnknownDocument())return I();r.unknownDocument={path:n.path.toArray(),version:zi(t.version)}}return r}function Bi(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function zi(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function $i(e){const t=new K(e.seconds,e.nanoseconds);return G.fromTimestamp(t)}function Ki(e,t){const n=(t.baseMutations||[]).map((t=>Si(e.Tt,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>Si(e.Tt,t))),s=K.fromMillis(t.localWriteTimeMs);return new Ms(t.batchId,s,n,r)}function Gi(e){const t=$i(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?$i(e.lastLimboFreeSnapshotVersion):G.min();let r;return r=function(e){return void 0!==e.documents}(e.query)?function(e){return _(1===e.documents.length),Rr(kr(vi(e.documents[0])))}(e.query):function(e){return Rr(ki(e))}(e.query),new Pi(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,en.fromBase64String(e.resumeToken))}function ji(e,t){const n=zi(t.snapshotVersion),r=zi(t.lastLimboFreeSnapshotVersion);let s;s=Tr(t.target)?xi(e.Tt,t.target):Ni(e.Tt,t.target).ht;const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Ir(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Qi(e){const t=ki({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Mr(t,t.limit,"L"):t}function Wi(e,t){return new Os(t.largestBatchId,Si(e.Tt,t.overlayMutation))}function Hi(e,t){const n=t.path.lastSegment();return[e,Re(t.path.popLast()),n]}function Yi(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:zi(r.readTime),documentKey:Re(r.documentKey.path),largestBatchId:r.largestBatchId}}class Zi{getBundleMetadata(e,t){return Ji(e).get(t).next((e=>{if(e)return function(e){return{id:e.bundleId,createTime:$i(e.createTime),version:e.version}}(e)}))}saveBundleMetadata(e,t){return Ji(e).put(function(e){return{bundleId:e.id,createTime:zi(di(e.createTime)),version:e.version}}(t))}getNamedQuery(e,t){return Xi(e).get(t).next((e=>{if(e)return function(e){return{name:e.name,query:Qi(e.bundledQuery),readTime:$i(e.readTime)}}(e)}))}saveNamedQuery(e,t){return Xi(e).put(function(e){return{name:e.name,readTime:zi(di(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function Ji(e){return Bt(e,mt)}function Xi(e){return Bt(e,gt)}class eo{constructor(e,t){this.serializer=e,this.userId=t}static It(e,t){const n=t.uid||"";return new eo(e,n)}getOverlay(e,t){return to(e).get(Hi(this.userId,t)).next((e=>e?Wi(this.serializer,e):null))}getOverlays(e,t){const n=Hr();return he.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new Os(t,s);r.push(this.Et(e,i))})),he.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(Re(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(to(e).J(kt,r))})),he.waitFor(s)}getOverlaysForCollection(e,t,n){const r=Hr(),s=Re(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return to(e).G(kt,i).next((e=>{for(const t of e){const e=Wi(this.serializer,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=Hr();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return to(e).Z({index:Ct,range:o},((e,t,n)=>{const o=Wi(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}Et(e,t){return to(e).put(function(e,t,n){const[r,s,i]=Hi(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ei(e.Tt,n.mutation)}}(this.serializer,this.userId,t))}}function to(e){return Bt(e,xt)}class no{dt(e){return Bt(e,Rt)}getSessionToken(e){return this.dt(e).get("sessionToken").next((e=>{const t=null==e?void 0:e.value;return t?en.fromUint8Array(t):en.EMPTY_BYTE_STRING}))}setSessionToken(e,t){return this.dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class ro{constructor(){}At(e,t){this.Rt(e,t),t.Vt()}Rt(e,t){if("nullValue"in e)this.ft(t,5);else if("booleanValue"in e)this.ft(t,10),t.gt(e.booleanValue?1:0);else if("integerValue"in e)this.ft(t,15),t.gt(rn(e.integerValue));else if("doubleValue"in e){const n=rn(e.doubleValue);isNaN(n)?this.ft(t,13):(this.ft(t,15),De(n)?t.gt(0):t.gt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.ft(t,20),"string"==typeof n&&(n=nn(n)),t.yt(`${n.seconds||""}`),t.gt(n.nanos||0)}else if("stringValue"in e)this.wt(e.stringValue,t),this.St(t);else if("bytesValue"in e)this.ft(t,30),t.bt(sn(e.bytesValue)),this.St(t);else if("referenceValue"in e)this.Dt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ft(t,45),t.gt(n.latitude||0),t.gt(n.longitude||0)}else"mapValue"in e?qn(e)?this.ft(t,Number.MAX_SAFE_INTEGER):On(e)?this.vt(e.mapValue,t):(this.Ct(e.mapValue,t),this.St(t)):"arrayValue"in e?(this.Ft(e.arrayValue,t),this.St(t)):I()}wt(e,t){this.ft(t,25),this.Mt(e,t)}Mt(e,t){t.yt(e)}Ct(e,t){const n=e.fields||{};this.ft(t,55);for(const r of Object.keys(n))this.wt(r,t),this.Rt(n[r],t)}vt(e,t){var n,r;const s=e.fields||{};this.ft(t,53);const i=In,o=(null===(r=null===(n=s[i].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.length)||0;this.ft(t,15),t.gt(rn(o)),this.wt(i,t),this.Rt(s[i],t)}Ft(e,t){const n=e.values||[];this.ft(t,50);for(const r of n)this.Rt(r,t)}Dt(e,t){this.ft(t,37),Z.fromName(e).path.forEach((e=>{this.ft(t,60),this.Mt(e,t)}))}ft(e,t){e.gt(t)}St(e){e.gt(2)}}ro.xt=new ro;const so=255;function io(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}function oo(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=io(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}class ao{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ot(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Nt(n.value),n=t.next();this.Bt()}Lt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.kt(n.value),n=t.next();this.qt()}Qt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Nt(e);else if(e<2048)this.Nt(960|e>>>6),this.Nt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Nt(480|e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e);else{const e=t.codePointAt(0);this.Nt(240|e>>>18),this.Nt(128|63&e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e)}}this.Bt()}$t(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.kt(e);else if(e<2048)this.kt(960|e>>>6),this.kt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.kt(480|e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e);else{const e=t.codePointAt(0);this.kt(240|e>>>18),this.kt(128|63&e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e)}}this.qt()}Ut(e){const t=this.Kt(e),n=oo(t);this.Wt(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}Gt(e){const t=this.Kt(e),n=oo(t);this.Wt(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}zt(){this.jt(so),this.jt(255)}Ht(){this.Jt(so),this.Jt(255)}reset(){this.position=0}seed(e){this.Wt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Yt(){return this.buffer.slice(0,this.position)}Kt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Nt(e){const t=255&e;0===t?(this.jt(0),this.jt(255)):t===so?(this.jt(so),this.jt(0)):this.jt(t)}kt(e){const t=255&e;0===t?(this.Jt(0),this.Jt(255)):t===so?(this.Jt(so),this.Jt(0)):this.Jt(e)}Bt(){this.jt(0),this.jt(1)}qt(){this.Jt(0),this.Jt(1)}jt(e){this.Wt(1),this.buffer[this.position++]=e}Jt(e){this.Wt(1),this.buffer[this.position++]=~e}Wt(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class uo{constructor(e){this.Zt=e}bt(e){this.Zt.Ot(e)}yt(e){this.Zt.Qt(e)}gt(e){this.Zt.Ut(e)}Vt(){this.Zt.zt()}}class co{constructor(e){this.Zt=e}bt(e){this.Zt.Lt(e)}yt(e){this.Zt.$t(e)}gt(e){this.Zt.Gt(e)}Vt(){this.Zt.Ht()}}class lo{constructor(){this.Zt=new ao,this.Xt=new uo(this.Zt),this.en=new co(this.Zt)}seed(e){this.Zt.seed(e)}tn(e){return 0===e?this.Xt:this.en}Yt(){return this.Zt.Yt()}reset(){this.Zt.reset()}}class ho{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}nn(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new ho(this.indexId,this.documentKey,this.arrayValue,n)}}function fo(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=mo(e.arrayValue,t.arrayValue),0!==n?n:(n=mo(e.directionalValue,t.directionalValue),0!==n?n:Z.comparator(e.documentKey,t.documentKey)))}function mo(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class go{constructor(e){this.rn=new Wt(((e,t)=>Y.comparator(e.field,t.field))),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.sn=e.orderBy,this._n=[];for(const t of e.filters){const e=t;e.isInequality()?this.rn=this.rn.add(e):this._n.push(e)}}get an(){return this.rn.size>1}un(e){if(_(e.collectionGroup===this.collectionId),this.an)return!1;const t=ee(e);if(void 0!==t&&!this.cn(t))return!1;const n=te(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.cn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.rn.size>0){const e=this.rn.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.ln(e,t)||!this.hn(this.sn[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.sn.length||!this.hn(this.sn[i++],e))return!1}return!0}Pn(){if(this.an)return null;let e=new Wt(Y.comparator);const t=[];for(const n of this._n)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new ne(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new ne(n.field,0))}for(const n of this.sn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new ne(n.field,"asc"===n.dir?0:1)));return new X(X.UNKNOWN_ID,this.collectionId,t,re.empty())}cn(e){for(const t of this._n)if(this.ln(t,e))return!0;return!1}ln(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}hn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function po(e){var t,n;if(_(e instanceof er||e instanceof tr),e instanceof er){if(e instanceof gr){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>er.create(e.field,"==",t))))||[];return tr.create(r,"or")}return e}const r=e.filters.map((e=>po(e)));return tr.create(r,e.op)}function yo(e){if(0===e.getFilters().length)return[];const t=_o(po(e));return _(Io(t)),wo(t)||vo(t)?[t]:t.getFilters()}function wo(e){return e instanceof er}function vo(e){return e instanceof tr&&sr(e)}function Io(e){return wo(e)||vo(e)||function(e){if(e instanceof tr&&rr(e)){for(const t of e.getFilters())if(!wo(t)&&!vo(t))return!1;return!0}return!1}(e)}function _o(e){if(_(e instanceof er||e instanceof tr),e instanceof er)return e;if(1===e.filters.length)return _o(e.filters[0]);const t=e.filters.map((e=>_o(e)));let n=tr.create(t,e.op);return n=Eo(n),Io(n)?n:(_(n instanceof tr),_(nr(n)),_(n.filters.length>1),n.filters.reduce(((e,t)=>To(e,t))))}function To(e,t){let n;return _(e instanceof er||e instanceof tr),_(t instanceof er||t instanceof tr),n=e instanceof er?t instanceof er?function(e,t){return tr.create([e,t],"and")}(e,t):bo(e,t):t instanceof er?bo(t,e):function(e,t){if(_(e.filters.length>0&&t.filters.length>0),nr(e)&&nr(t))return ur(e,t.getFilters());const n=rr(e)?e:t,r=rr(e)?t:e,s=n.filters.map((e=>To(e,r)));return tr.create(s,"or")}(e,t),Eo(n)}function bo(e,t){if(nr(t))return ur(t,e.getFilters());{const n=t.filters.map((t=>To(e,t)));return tr.create(n,"or")}}function Eo(e){if(_(e instanceof er||e instanceof tr),e instanceof er)return e;const t=e.getFilters();if(1===t.length)return Eo(t[0]);if(ir(e))return e;const n=t.map((e=>Eo(e))),r=[];return n.forEach((t=>{t instanceof er?r.push(t):t instanceof tr&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:tr.create(r,e.op)}class So{constructor(){this.Tn=new xo}addToCollectionParentIndex(e,t){return this.Tn.add(t),he.resolve()}getCollectionParents(e,t){return he.resolve(this.Tn.getEntries(t))}addFieldIndex(e,t){return he.resolve()}deleteFieldIndex(e,t){return he.resolve()}deleteAllFieldIndexes(e){return he.resolve()}createTargetIndexes(e,t){return he.resolve()}getDocumentsMatchingTarget(e,t){return he.resolve(null)}getIndexType(e,t){return he.resolve(0)}getFieldIndexes(e,t){return he.resolve([])}getNextCollectionGroupToUpdate(e){return he.resolve(null)}getMinOffset(e,t){return he.resolve(oe.min())}getMinOffsetFromCollectionGroup(e,t){return he.resolve(oe.min())}updateCollectionGroup(e,t,n){return he.resolve()}updateIndexEntries(e,t){return he.resolve()}}class xo{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Wt(W.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Wt(W.comparator)).toArray()}}const No="IndexedDbIndexManager",ko=new Uint8Array(0);class Do{constructor(e,t){this.databaseId=t,this.In=new xo,this.En=new $r((e=>Ir(e)),((e,t)=>_r(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.In.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.In.add(t)}));const s={collectionId:n,parent:Re(r)};return Co(e).put(s)}return he.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[B(t),""],!1,!0);return Co(e).G(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Me(r.parent))}return n}))}addFieldIndex(e,t){const n=Ro(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=Vo(e);return s.next((e=>{n.put(Yi(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=Ro(e),r=Vo(e),s=Ao(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}deleteAllFieldIndexes(e){const t=Ro(e),n=Ao(e),r=Vo(e);return t.J().next((()=>n.J())).next((()=>r.J()))}createTargetIndexes(e,t){return he.forEach(this.dn(t),(t=>this.getIndexType(e,t).next((n=>{if(0===n||1===n){const n=new go(t).Pn();if(null!=n)return this.addFieldIndex(e,n)}}))))}getDocumentsMatchingTarget(e,t){const n=Ao(e);let r=!0;const s=new Map;return he.forEach(this.dn(t),(t=>this.An(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=es();const r=[];return he.forEach(s,((s,i)=>{p(No,`Using index ${function(e){return`id=${e.indexId}|cg=${e.collectionGroup}|f=${e.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`}(s)} to execute ${Ir(t)}`);const o=function(e,t){const n=ee(t);if(void 0===n)return null;for(const r of br(e,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),a=function(e,t){const n=new Map;for(const r of te(t))for(const t of br(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),u=function(e,t){const n=[];let r=!0;for(const s of te(t)){const t=0===s.kind?Er(e,s.fieldPath,e.startAt):Sr(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Wn(n,r)}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of te(t)){const t=0===s.kind?Sr(e,s.fieldPath,e.endAt):Er(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Wn(n,r)}(i,s),l=this.Rn(s,i,u),h=this.Rn(s,i,c),d=this.Vn(s,i,a),f=this.mn(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return he.forEach(f,(s=>n.H(s,t.limit).next((t=>{t.forEach((t=>{const n=Z.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return he.resolve(null)}))}dn(e){let t=this.En.get(e);return t||(t=0===e.filters.length?[e]:yo(tr.create(e.filters,"and")).map((t=>vr(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.En.set(e,t),t)}mn(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.fn(t[l/u]):ko,h=this.gn(e,a,n[l%u],r),d=this.pn(e,a,s[l%u],i),f=o.map((t=>this.gn(e,a,t,!0)));c.push(...this.createRange(h,d,f))}return c}gn(e,t,n,r){const s=new ho(e,Z.empty(),t,n);return r?s:s.nn()}pn(e,t,n,r){const s=new ho(e,Z.empty(),t,n);return r?s.nn():s}An(e,t){const n=new go(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.un(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.dn(t);return he.forEach(r,(t=>this.An(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new Wt(Y.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n))}yn(e,t){const n=new lo;for(const r of te(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.tn(r.kind);ro.xt.At(e,s)}return n.Yt()}fn(e){const t=new lo;return ro.xt.At(e,t.tn(0)),t.Yt()}wn(e,t){const n=new lo;return ro.xt.At(An(this.databaseId,t),n.tn(function(e){const t=te(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Yt()}Vn(e,t,n){if(null===n)return[];let r=[];r.push(new lo);let s=0;for(const i of te(e)){const e=n[s++];for(const n of r)if(this.Sn(t,i.fieldPath)&&Vn(e))r=this.bn(r,i,e);else{const t=n.tn(i.kind);ro.xt.At(e,t)}}return this.Dn(r)}Rn(e,t,n){return this.Vn(e,t,n.position)}Dn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Yt();return t}bn(e,t,n){const r=[...e],s=[];for(const i of n.arrayValue.values||[])for(const e of r){const n=new lo;n.seed(e.Yt()),ro.xt.At(i,n.tn(t.kind)),s.push(n)}return s}Sn(e,t){return!!e.filters.find((e=>e instanceof er&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Ro(e),r=Vo(e);return(t?n.G(yt,IDBKeyRange.bound(t,t)):n.G()).next((e=>{const t=[];return he.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new re(t.sequenceNumber,new oe($i(t.readTime),new Z(Me(t.documentKey)),t.largestBatchId)):re.empty(),r=e.fields.map((([e,t])=>new ne(Y.fromServerFormat(e),t)));return new X(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:P(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=Ro(e),s=Vo(e);return this.vn(e).next((e=>r.G(yt,IDBKeyRange.bound(t,t)).next((t=>he.forEach(t,(t=>s.put(Yi(t.indexId,this.uid,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return he.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?he.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),he.forEach(s,(n=>this.Cn(e,t,n).next((t=>{const s=this.Fn(r,n);return t.isEqual(s)?he.resolve():this.Mn(e,r,n,t,s)})))))))}))}xn(e,t,n,r){return Ao(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.wn(n,t.key),documentKey:t.key.path.toArray()})}On(e,t,n,r){return Ao(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.wn(n,t.key),t.key.path.toArray()])}Cn(e,t,n){const r=Ao(e);let s=new Wt(fo);return r.Z({index:Et,range:IDBKeyRange.only([n.indexId,this.uid,this.wn(n,t)])},((e,r)=>{s=s.add(new ho(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}Fn(e,t){let n=new Wt(fo);const r=this.yn(t,e);if(null==r)return n;const s=ee(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Vn(i))for(const s of i.arrayValue.values||[])n=n.add(new ho(t.indexId,e.key,this.fn(s),r))}else n=n.add(new ho(t.indexId,e.key,ko,r));return n}Mn(e,t,n,r,s){p(No,"Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=Yt(i),u=Yt(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=Yt(o)):t?(s(a),a=Yt(i)):(a=Yt(i),u=Yt(o))}}(r,s,fo,(r=>{i.push(this.xn(e,t,n,r))}),(r=>{i.push(this.On(e,t,n,r))})),he.waitFor(i)}vn(e){let t=1;return Vo(e).Z({index:It,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>fo(e,t))).filter(((e,t,n)=>!t||0!==fo(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=fo(i,e),s=fo(i,t);if(0===n)r[0]=e.nn();else if(n>0&&s<0)r.push(i),r.push(i.nn());else if(s>0)break}r.push(t);const s=[];for(let i=0;i<r.length;i+=2){if(this.Nn(r[i],r[i+1]))return[];const e=[r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,ko,[]],t=[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,ko,[]];s.push(IDBKeyRange.bound(e,t))}return s}Nn(e,t){return fo(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Lo)}getMinOffset(e,t){return he.mapArray(this.dn(t),(t=>this.An(e,t).next((e=>e||I())))).next(Lo)}}function Co(e){return Bt(e,ht)}function Ao(e){return Bt(e,Tt)}function Ro(e){return Bt(e,pt)}function Vo(e){return Bt(e,wt)}function Lo(e){_(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;ae(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new oe(t.readTime,t.documentKey,n)}const Mo={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Fo=41943040;class Oo{static withCacheSize(e){return new Oo(e,Oo.DEFAULT_COLLECTION_PERCENTILE,Oo.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function Po(e,t,n){const r=e.store(Ue),s=e.store(Qe),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Z({range:o},((e,t,n)=>(a++,n.delete())));i.push(u.next((()=>{_(1===a)})));const c=[];for(const l of n.mutations){const e=Ge(t,l.key.path,n.batchId);i.push(s.delete(e)),c.push(l.key)}return he.waitFor(i).next((()=>c))}function qo(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw I();t=e.noDocument}return JSON.stringify(t).length}Oo.DEFAULT_COLLECTION_PERCENTILE=10,Oo.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Oo.DEFAULT=new Oo(Fo,Oo.DEFAULT_COLLECTION_PERCENTILE,Oo.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Oo.DISABLED=new Oo(-1,0,0);class Uo{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Bn={}}static It(e,t,n,r){_(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Uo(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return zo(e).Z({index:ze,range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=$o(e),i=zo(e);return i.add({}).next((o=>{_("number"==typeof o);const a=new Ms(o,t,n,r),u=function(e,t,n){const r=n.baseMutations.map((t=>Ei(e.Tt,t))),s=n.mutations.map((t=>Ei(e.Tt,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new Wt(((e,t)=>P(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Ge(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,je))}return l.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Bn[o]=a.keys()})),he.waitFor(c).next((()=>a))}))}lookupMutationBatch(e,t){return zo(e).get(t).next((e=>e?(_(e.userId===this.userId),Ki(this.serializer,e)):null))}Ln(e,t){return this.Bn[t]?he.resolve(this.Bn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Bn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return zo(e).Z({index:ze,range:r},((e,t,r)=>{t.userId===this.userId&&(_(t.batchId>=n),s=Ki(this.serializer,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=Ne;return zo(e).Z({index:ze,range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,Ne],[this.userId,Number.POSITIVE_INFINITY]);return zo(e).G(ze,t).next((e=>e.map((e=>Ki(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Ke(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return $o(e).Z({range:r},((n,r,i)=>{const[o,a,u]=n,c=Me(a);if(o===this.userId&&t.path.isEqual(c))return zo(e).get(u).next((e=>{if(!e)throw I();_(e.userId===this.userId),s.push(Ki(this.serializer,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Wt(P);const r=[];return t.forEach((t=>{const s=Ke(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=$o(e).Z({range:i},((e,r,s)=>{const[i,o,a]=e,u=Me(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),he.waitFor(r).next((()=>this.kn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=Ke(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Wt(P);return $o(e).Z({range:i},((e,t,s)=>{const[i,a,u]=e,c=Me(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.kn(e,o)))}kn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(zo(e).get(t).next((e=>{if(null===e)throw I();_(e.userId===this.userId),n.push(Ki(this.serializer,e))})))})),he.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Po(e.ue,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.qn(t.batchId)})),he.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}qn(e){delete this.Bn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return he.resolve();const n=IDBKeyRange.lowerBound(function(e){return[e]}(this.userId)),r=[];return $o(e).Z({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Me(e[1]);r.push(t)}else n.done()})).next((()=>{_(0===r.length)}))}))}containsKey(e,t){return Bo(e,this.userId,t)}Qn(e){return Ko(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:Ne,lastStreamToken:""}))}}function Bo(e,t,n){const r=Ke(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return $o(e).Z({range:i,Y:!0},((e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function zo(e){return Bt(e,Ue)}function $o(e){return Bt(e,Qe)}function Ko(e){return Bt(e,qe)}class Go{constructor(e){this.$n=e}next(){return this.$n+=2,this.$n}static Un(){return new Go(0)}static Kn(){return new Go(-1)}}class jo{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Wn(e).next((t=>{const n=new Go(t.highestTargetId);return t.highestTargetId=n.next(),this.Gn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.Wn(e).next((e=>G.fromTimestamp(new K(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.Wn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.Wn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Gn(e,r))))}addTargetData(e,t){return this.zn(e,t).next((()=>this.Wn(e).next((n=>(n.targetCount+=1,this.jn(t,n),this.Gn(e,n))))))}updateTargetData(e,t){return this.zn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Qo(e).delete(t.targetId))).next((()=>this.Wn(e))).next((t=>(_(t.targetCount>0),t.targetCount-=1,this.Gn(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Qo(e).Z(((i,o)=>{const a=Gi(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>he.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Qo(e).Z(((e,n)=>{const r=Gi(n);t(r)}))}Wn(e){return Wo(e).get(ct).next((e=>(_(null!==e),e)))}Gn(e,t){return Wo(e).put(ct,t)}zn(e,t){return Qo(e).put(ji(this.serializer,t))}jn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Wn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=Ir(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Qo(e).Z({range:r,index:rt},((e,n,r)=>{const i=Gi(n);_r(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=Ho(e);return t.forEach((t=>{const i=Re(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),he.waitFor(r)}removeMatchingKeys(e,t,n){const r=Ho(e);return he.forEach(t,(t=>{const s=Re(t.path);return he.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=Ho(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Ho(e);let s=es();return r.Z({range:n,Y:!0},((e,t,n)=>{const r=Me(e[1]),i=new Z(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=Re(t.path),r=IDBKeyRange.bound([n],[B(n)],!1,!0);let s=0;return Ho(e).Z({index:at,Y:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}lt(e,t){return Qo(e).get(t).next((e=>e?Gi(e):null))}}function Qo(e){return Bt(e,nt)}function Wo(e){return Bt(e,lt)}function Ho(e){return Bt(e,it)}const Yo="LruGarbageCollector",Zo=1048576;function Jo([e,t],[n,r]){const s=P(e,n);return 0===s?P(t,r):s}class Xo{constructor(e){this.Hn=e,this.buffer=new Wt(Jo),this.Jn=0}Yn(){return++this.Jn}Zn(e){const t=[e,this.Yn()];if(this.buffer.size<this.Hn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Jo(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class ea{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Xn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.er(6e4)}stop(){this.Xn&&(this.Xn.cancel(),this.Xn=null)}get started(){return null!==this.Xn}er(e){p(Yo,`Garbage collection scheduled in ${e}ms`),this.Xn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Xn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){we(e)?p(Yo,"Ignoring IndexedDB error during garbage collection: ",e):await le(e)}await this.er(3e5)}))}}class ta{constructor(e,t){this.tr=e,this.params=t}calculateTargetCount(e,t){return this.tr.nr(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return he.resolve(xe.ae);const n=new Xo(t);return this.tr.forEachTarget(e,(e=>n.Zn(e.sequenceNumber))).next((()=>this.tr.rr(e,(e=>n.Zn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.tr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.tr.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(p("LruGarbageCollector","Garbage collection skipped; disabled"),he.resolve(Mo)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(p("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Mo):this.ir(e,t)))}getCacheSize(e){return this.tr.getCacheSize(e)}ir(e,t){let n,r,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(p("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),m()<=i.in.DEBUG&&p("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),he.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}function na(e,t){return new ta(e,t)}class ra{constructor(e,t){this.db=e,this.garbageCollector=na(this,t)}nr(e){const t=this.sr(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}sr(e){let t=0;return this.rr(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}rr(e,t){return this._r(e,((e,n)=>t(n)))}addReference(e,t,n){return sa(e,n)}removeReference(e,t,n){return sa(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return sa(e,t)}ar(e,t){return function(e,t){let n=!1;return Ko(e).X((r=>Bo(e,r,t).next((e=>(e&&(n=!0),he.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this._r(e,((i,o)=>{if(o<=t){const t=this.ar(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,G.min()),Ho(e).delete(function(e){return[0,Re(e.path)]}(i)))))}));r.push(t)}})).next((()=>he.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return sa(e,t)}_r(e,t){const n=Ho(e);let r,s=xe.ae;return n.Z({index:at},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==xe.ae&&t(new Z(Me(r)),s),s=o,r=i):s=xe.ae})).next((()=>{s!==xe.ae&&t(new Z(Me(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sa(e,t){return Ho(e).put(function(e,t){return{targetId:0,path:Re(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class ia{constructor(){this.changes=new $r((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Qn.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?he.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class oa{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return la(e).put(n)}removeEntry(e,t,n){return la(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Bi(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.ur(e,n))))}getEntry(e,t){let n=Qn.newInvalidDocument(t);return la(e).Z({index:Ye,range:IDBKeyRange.only(ha(t))},((e,r)=>{n=this.cr(t,r)})).next((()=>n))}lr(e,t){let n={size:0,document:Qn.newInvalidDocument(t)};return la(e).Z({index:Ye,range:IDBKeyRange.only(ha(t))},((e,r)=>{n={document:this.cr(t,r),size:qo(r)}})).next((()=>n))}getEntries(e,t){let n=Gr();return this.hr(e,t,((e,t)=>{const r=this.cr(e,t);n=n.insert(e,r)})).next((()=>n))}Pr(e,t){let n=Gr(),r=new Gt(Z.comparator);return this.hr(e,t,((e,t)=>{const s=this.cr(e,t);n=n.insert(e,s),r=r.insert(e,qo(t))})).next((()=>({documents:n,Tr:r})))}hr(e,t,n){if(t.isEmpty())return he.resolve();let r=new Wt(fa);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(ha(r.first()),ha(r.last())),i=r.getIterator();let o=i.getNext();return la(e).Z({index:Ye,range:s},((e,t,r)=>{const s=Z.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&fa(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.W(ha(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r,s){const i=t.path,o=[i.popLast().toArray(),i.lastSegment(),Bi(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return la(e).G(IDBKeyRange.bound(o,a,!0)).next((e=>{null==s||s.incrementDocumentReadCount(e.length);let n=Gr();for(const s of e){const e=this.cr(Z.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(qr(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let s=Gr();const i=da(t,n),o=da(t,oe.max());return la(e).Z({index:Je,range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.cr(Z.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new ua(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return ca(e).get(tt).next((e=>(_(!!e),e)))}ur(e,t){return ca(e).put(tt,t)}cr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=bi(e.Tt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=Z.fromSegments(t.noDocument.path),r=$i(t.noDocument.readTime);n=Qn.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return I();{const e=Z.fromSegments(t.unknownDocument.path),r=$i(t.unknownDocument.version);n=Qn.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new K(e[0],e[1]);return G.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(G.min()))return e}return Qn.newInvalidDocument(e)}}function aa(e){return new oa(e)}class ua extends ia{constructor(e,t){super(),this.Ir=e,this.trackRemovals=t,this.Er=new $r((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new Wt(((e,t)=>P(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Er.get(s);if(t.push(this.Ir.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=Ui(this.Ir.serializer,i);r=r.add(s.path.popLast());const u=qo(a);n+=u-o.size,t.push(this.Ir.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=Ui(this.Ir.serializer,i.convertToNoDocument(G.min()));t.push(this.Ir.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.Ir.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.Ir.updateMetadata(e,n)),he.waitFor(t)}getFromCache(e,t){return this.Ir.lr(e,t).next((e=>(this.Er.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.Ir.Pr(e,t).next((({documents:e,Tr:t})=>(t.forEach(((t,n)=>{this.Er.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function ca(e){return Bt(e,et)}function la(e){return Bt(e,We)}function ha(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function da(e,t){const n=t.documentKey.path.toArray();return[e,Bi(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function fa(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=P(n[i],r[i]),s)return s;return s=P(n.length,r.length),s||(s=P(n[n.length-2],r[r.length-2]),s||P(n[n.length-1],r[r.length-1]))}class ma{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class ga{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Ss(n.mutation,e,Zt.empty(),K.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,es()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=es()){const r=Hr();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Qr();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Hr();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,es())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=Gr();const i=Zr(),o=Zr();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof Ds)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),Ss(o.mutation,t,o.mutation.getFieldMask(),K.now())):i.set(t.key,Zt.empty())})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new ma(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Zr();let r=new Gt(((e,t)=>e-t)),s=es();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||Zt.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||es()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=Yr();u.forEach((e=>{if(!s.has(e)){const r=bs(t.get(e),n.get(e));null!==r&&c.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return he.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,r){return function(e){return Z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Cr(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):he.resolve(Hr());let o=J,a=s;return i.next((t=>he.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?he.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,es()))).next((e=>({batchId:o,changes:Wr(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Z(t)).next((e=>{let t=Qr();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const s=t.collectionGroup;let i=Qr();return this.indexManager.getCollectionParents(e,s).next((o=>he.forEach(o,(o=>{const a=function(e,t){return new xr(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,o.child(s));return this.getDocumentsMatchingCollectionQuery(e,a,n,r).next((e=>{e.forEach(((e,t)=>{i=i.insert(e,t)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(e,t,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,r)))).next((e=>{s.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Qn.newInvalidDocument(r)))}));let n=Qr();return e.forEach(((e,r)=>{const i=s.get(e);void 0!==i&&Ss(i.mutation,r,Zt.empty(),K.now()),qr(t,r)&&(n=n.insert(e,r))})),n}))}}class pa{constructor(e){this.serializer=e,this.dr=new Map,this.Ar=new Map}getBundleMetadata(e,t){return he.resolve(this.dr.get(t))}saveBundleMetadata(e,t){return this.dr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:di(e.createTime)}}(t)),he.resolve()}getNamedQuery(e,t){return he.resolve(this.Ar.get(t))}saveNamedQuery(e,t){return this.Ar.set(t.name,function(e){return{name:e.name,query:Qi(e.bundledQuery),readTime:di(e.readTime)}}(t)),he.resolve()}}class ya{constructor(){this.overlays=new Gt(Z.comparator),this.Rr=new Map}getOverlay(e,t){return he.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Hr();return he.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.Et(e,t,r)})),he.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Rr.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.Rr.delete(n)),he.resolve()}getOverlaysForCollection(e,t,n){const r=Hr(),s=t.length+1,i=new Z(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return he.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new Gt(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=Hr(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Hr(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return he.resolve(o)}Et(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.Rr.get(r.largestBatchId).delete(n.key);this.Rr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Os(t,n));let s=this.Rr.get(t);void 0===s&&(s=es(),this.Rr.set(t,s)),this.Rr.set(t,s.add(n.key))}}class wa{constructor(){this.sessionToken=en.EMPTY_BYTE_STRING}getSessionToken(e){return he.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,he.resolve()}}class va{constructor(){this.Vr=new Wt(Ia.mr),this.gr=new Wt(Ia.pr)}isEmpty(){return this.Vr.isEmpty()}addReference(e,t){const n=new Ia(e,t);this.Vr=this.Vr.add(n),this.gr=this.gr.add(n)}yr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.wr(new Ia(e,t))}Sr(e,t){e.forEach((e=>this.removeReference(e,t)))}br(e){const t=new Z(new W([])),n=new Ia(t,e),r=new Ia(t,e+1),s=[];return this.gr.forEachInRange([n,r],(e=>{this.wr(e),s.push(e.key)})),s}Dr(){this.Vr.forEach((e=>this.wr(e)))}wr(e){this.Vr=this.Vr.delete(e),this.gr=this.gr.delete(e)}vr(e){const t=new Z(new W([])),n=new Ia(t,e),r=new Ia(t,e+1);let s=es();return this.gr.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new Ia(e,0),n=this.Vr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Ia{constructor(e,t){this.key=e,this.Cr=t}static mr(e,t){return Z.comparator(e.key,t.key)||P(e.Cr,t.Cr)}static pr(e,t){return P(e.Cr,t.Cr)||Z.comparator(e.key,t.key)}}class _a{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Fr=1,this.Mr=new Wt(Ia.mr)}checkEmpty(e){return he.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.Fr;this.Fr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Ms(s,t,n,r);this.mutationQueue.push(i);for(const o of r)this.Mr=this.Mr.add(new Ia(o.key,s)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return he.resolve(i)}lookupMutationBatch(e,t){return he.resolve(this.Or(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.Nr(n),s=r<0?0:r;return he.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return he.resolve(0===this.mutationQueue.length?Ne:this.Fr-1)}getAllMutationBatches(e){return he.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Ia(t,0),r=new Ia(t,Number.POSITIVE_INFINITY),s=[];return this.Mr.forEachInRange([n,r],(e=>{const t=this.Or(e.Cr);s.push(t)})),he.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Wt(P);return t.forEach((e=>{const t=new Ia(e,0),r=new Ia(e,Number.POSITIVE_INFINITY);this.Mr.forEachInRange([t,r],(e=>{n=n.add(e.Cr)}))})),he.resolve(this.Br(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;Z.isDocumentKey(s)||(s=s.child(""));const i=new Ia(new Z(s),0);let o=new Wt(P);return this.Mr.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.Cr)),!0)}),i),he.resolve(this.Br(o))}Br(e){const t=[];return e.forEach((e=>{const n=this.Or(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){_(0===this.Lr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.Mr;return he.forEach(t.mutations,(r=>{const s=new Ia(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.Mr=n}))}qn(e){}containsKey(e,t){const n=new Ia(t,0),r=this.Mr.firstAfterOrEqual(n);return he.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,he.resolve()}Lr(e,t){return this.Nr(e)}Nr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Or(e){const t=this.Nr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Ta{constructor(e){this.kr=e,this.docs=new Gt(Z.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.kr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return he.resolve(n?n.document.mutableCopy():Qn.newInvalidDocument(t))}getEntries(e,t){let n=Gr();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Qn.newInvalidDocument(e))})),he.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Gr();const i=t.path,o=new Z(i.child("__id-9223372036854775808__")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||ae(ie(o),n)<=0||(r.has(o.key)||qr(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return he.resolve(s)}getAllFromCollectionGroup(e,t,n,r){I()}qr(e,t){return he.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new ba(this)}getSize(e){return he.resolve(this.size)}}class ba extends ia{constructor(e){super(),this.Ir=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.Ir.addEntry(e,r)):this.Ir.removeEntry(n)})),he.waitFor(t)}getFromCache(e,t){return this.Ir.getEntry(e,t)}getAllFromCache(e,t){return this.Ir.getEntries(e,t)}}class Ea{constructor(e){this.persistence=e,this.Qr=new $r((e=>Ir(e)),_r),this.lastRemoteSnapshotVersion=G.min(),this.highestTargetId=0,this.$r=0,this.Ur=new va,this.targetCount=0,this.Kr=Go.Un()}forEachTarget(e,t){return this.Qr.forEach(((e,n)=>t(n))),he.resolve()}getLastRemoteSnapshotVersion(e){return he.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return he.resolve(this.$r)}allocateTargetId(e){return this.highestTargetId=this.Kr.next(),he.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.$r&&(this.$r=t),he.resolve()}zn(e){this.Qr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Kr=new Go(t),this.highestTargetId=t),e.sequenceNumber>this.$r&&(this.$r=e.sequenceNumber)}addTargetData(e,t){return this.zn(t),this.targetCount+=1,he.resolve()}updateTargetData(e,t){return this.zn(t),he.resolve()}removeTargetData(e,t){return this.Qr.delete(t.target),this.Ur.br(t.targetId),this.targetCount-=1,he.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Qr.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Qr.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),he.waitFor(s).next((()=>r))}getTargetCount(e){return he.resolve(this.targetCount)}getTargetData(e,t){const n=this.Qr.get(t)||null;return he.resolve(n)}addMatchingKeys(e,t,n){return this.Ur.yr(t,n),he.resolve()}removeMatchingKeys(e,t,n){this.Ur.Sr(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),he.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Ur.br(t),he.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Ur.vr(t);return he.resolve(n)}containsKey(e,t){return he.resolve(this.Ur.containsKey(t))}}class Sa{constructor(e,t){this.Wr={},this.overlays={},this.Gr=new xe(0),this.zr=!1,this.zr=!0,this.jr=new wa,this.referenceDelegate=e(this),this.Hr=new Ea(this),this.indexManager=new So,this.remoteDocumentCache=function(e){return new Ta(e)}((e=>this.referenceDelegate.Jr(e))),this.serializer=new qi(t),this.Yr=new pa(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.zr=!1,Promise.resolve()}get started(){return this.zr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new ya,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Wr[e.toKey()];return n||(n=new _a(t,this.referenceDelegate),this.Wr[e.toKey()]=n),n}getGlobalsCache(){return this.jr}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Yr}runTransaction(e,t,n){p("MemoryPersistence","Starting transaction:",e);const r=new xa(this.Gr.next());return this.referenceDelegate.Zr(),n(r).next((e=>this.referenceDelegate.Xr(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}ei(e,t){return he.or(Object.values(this.Wr).map((n=>()=>n.containsKey(e,t))))}}class xa extends ce{constructor(e){super(),this.currentSequenceNumber=e}}class Na{constructor(e){this.persistence=e,this.ti=new va,this.ni=null}static ri(e){return new Na(e)}get ii(){if(this.ni)return this.ni;throw I()}addReference(e,t,n){return this.ti.addReference(n,t),this.ii.delete(n.toString()),he.resolve()}removeReference(e,t,n){return this.ti.removeReference(n,t),this.ii.add(n.toString()),he.resolve()}markPotentiallyOrphaned(e,t){return this.ii.add(t.toString()),he.resolve()}removeTarget(e,t){this.ti.br(t.targetId).forEach((e=>this.ii.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.ii.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Zr(){this.ni=new Set}Xr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return he.forEach(this.ii,(n=>{const r=Z.fromPath(n);return this.si(e,r).next((e=>{e||t.removeEntry(r,G.min())}))})).next((()=>(this.ni=null,t.apply(e))))}updateLimboDocument(e,t){return this.si(e,t).next((e=>{e?this.ii.delete(t.toString()):this.ii.add(t.toString())}))}Jr(e){return 0}si(e,t){return he.or([()=>he.resolve(this.ti.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.ei(e,t)])}}class ka{constructor(e,t){this.persistence=e,this.oi=new $r((e=>Re(e.path)),((e,t)=>e.isEqual(t))),this.garbageCollector=na(this,t)}static ri(e,t){return new ka(e,t)}Zr(){}Xr(e){return he.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}nr(e){const t=this.sr(e);return this.persistence.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}sr(e){let t=0;return this.rr(e,(e=>{t++})).next((()=>t))}rr(e,t){return he.forEach(this.oi,((n,r)=>this.ar(e,n,r).next((e=>e?he.resolve():t(r)))))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.qr(e,(r=>this.ar(e,r,t).next((e=>{e||(n++,s.removeEntry(r,G.min()))})))).next((()=>s.apply(e))).next((()=>n))}markPotentiallyOrphaned(e,t){return this.oi.set(t,e.currentSequenceNumber),he.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),he.resolve()}removeReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),he.resolve()}updateLimboDocument(e,t){return this.oi.set(t,e.currentSequenceNumber),he.resolve()}Jr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=Cn(e.data.value)),t}ar(e,t,n){return he.or([()=>this.persistence.ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const e=this.oi.get(t);return he.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class Da{constructor(e){this.serializer=e}B(e,t,n,r){const s=new fe("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore(Oe)}(e),function(e){e.createObjectStore(qe,{keyPath:"userId"});e.createObjectStore(Ue,{keyPath:Be,autoIncrement:!0}).createIndex(ze,$e,{unique:!0}),e.createObjectStore(Qe)}(e),Ca(e),function(e){e.createObjectStore(Fe)}(e));let i=he.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore(it),e.deleteObjectStore(nt),e.deleteObjectStore(lt)}(e),Ca(e)),i=i.next((()=>function(e){const t=e.store(lt),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:G.min().toTimestamp(),targetCount:0};return t.put(ct,n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store(Ue).G().next((n=>{e.deleteObjectStore(Ue),e.createObjectStore(Ue,{keyPath:Be,autoIncrement:!0}).createIndex(ze,$e,{unique:!0});const r=t.store(Ue),s=n.map((e=>r.put(e)));return he.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore(ft,{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this._i(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore(et)}(e),this.ai(s))))),n<7&&r>=7&&(i=i.next((()=>this.ui(s)))),n<8&&r>=8&&(i=i.next((()=>this.ci(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.li(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore(mt,{keyPath:"bundleId"})}(e),function(e){e.createObjectStore(gt,{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore(xt,{keyPath:Nt});t.createIndex(kt,Dt,{unique:!1}),t.createIndex(Ct,At,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore(We,{keyPath:He});t.createIndex(Ye,Ze),t.createIndex(Je,Xe)}(e))).next((()=>this.hi(e,s))).next((()=>e.deleteObjectStore(Fe)))),n<14&&r>=14&&(i=i.next((()=>this.Pi(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore(pt,{keyPath:"indexId",autoIncrement:!0}).createIndex(yt,"collectionGroup",{unique:!1});e.createObjectStore(wt,{keyPath:vt}).createIndex(It,_t,{unique:!1});e.createObjectStore(Tt,{keyPath:bt}).createIndex(Et,St,{unique:!1})}(e)))),n<16&&r>=16&&(i=i.next((()=>{t.objectStore(wt).clear()})).next((()=>{t.objectStore(Tt).clear()}))),n<17&&r>=17&&(i=i.next((()=>{!function(e){e.createObjectStore(Rt,{keyPath:"name"})}(e)}))),i}ai(e){let t=0;return e.store(Fe).Z(((e,n)=>{t+=qo(n)})).next((()=>{const n={byteSize:t};return e.store(et).put(tt,n)}))}_i(e){const t=e.store(qe),n=e.store(Ue);return t.G().next((t=>he.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,Ne],[t.userId,t.lastAcknowledgedBatchId]);return n.G(ze,r).next((n=>he.forEach(n,(n=>{_(n.userId===t.userId);const r=Ki(this.serializer,n);return Po(e,t.userId,r).next((()=>{}))}))))}))))}ui(e){const t=e.store(it),n=e.store(Fe);return e.store(lt).get(ct).next((e=>{const r=[];return n.Z(((n,s)=>{const i=new W(n),o=function(e){return[0,Re(e)]}(i);r.push(t.get(o).next((n=>n?he.resolve():(n=>t.put({targetId:0,path:Re(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>he.waitFor(r)))}))}ci(e,t){e.createObjectStore(ht,{keyPath:dt});const n=t.store(ht),r=new xo,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Re(r)})}};return t.store(Fe).Z({Y:!0},((e,t)=>{const n=new W(e);return s(n.popLast())})).next((()=>t.store(Qe).Z({Y:!0},(([e,t,n],r)=>{const i=Me(t);return s(i.popLast())}))))}li(e){const t=e.store(nt);return t.Z(((e,n)=>{const r=Gi(n),s=ji(this.serializer,r);return t.put(s)}))}hi(e,t){const n=t.store(Fe),r=[];return n.Z(((e,n)=>{const s=t.store(We),i=function(e){return e.document?new Z(W.fromString(e.document.name).popFirst(5)):e.noDocument?Z.fromSegments(e.noDocument.path):e.unknownDocument?Z.fromSegments(e.unknownDocument.path):I()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>he.waitFor(r)))}Pi(e,t){const n=t.store(Ue),r=aa(this.serializer),s=new Sa(Na.ri,this.serializer.Tt);return n.G().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:es();Ki(this.serializer,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),he.forEach(n,((e,n)=>{const i=new h(n),o=eo.It(this.serializer,i),a=s.getIndexManager(i),u=Uo.It(i,this.serializer,a,s.referenceDelegate);return new ga(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Ut(t,xe.ae),e).next()}))}))}}function Ca(e){e.createObjectStore(it,{keyPath:ot}).createIndex(at,ut,{unique:!0}),e.createObjectStore(nt,{keyPath:"targetId"}).createIndex(rt,st,{unique:!0}),e.createObjectStore(lt)}const Aa="IndexedDbPersistence",Ra=18e5,Va=5e3,La="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Ma="main";class Fa{constructor(e,t,n,r,s,i,o,a,u,c,l=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Ti=s,this.window=i,this.document=o,this.Ii=u,this.Ei=c,this.di=l,this.Gr=null,this.zr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ai=null,this.inForeground=!1,this.Ri=null,this.Vi=null,this.mi=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!Fa.D())throw new S(E.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ra(this,r),this.gi=t+Ma,this.serializer=new qi(a),this.pi=new me(this.gi,this.di,new Da(this.serializer)),this.jr=new no,this.Hr=new jo(this.referenceDelegate,this.serializer),this.remoteDocumentCache=aa(this.serializer),this.Yr=new Zi,this.window&&this.window.localStorage?this.yi=this.window.localStorage:(this.yi=null,!1===c&&y(Aa,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.wi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(E.FAILED_PRECONDITION,La);return this.Si(),this.bi(),this.Di(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Hr.getHighestSequenceNumber(e)))})).then((e=>{this.Gr=new xe(e,this.Ii)})).then((()=>{this.zr=!0})).catch((e=>(this.pi&&this.pi.close(),Promise.reject(e))))}Ci(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.pi.k((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ti.enqueueAndForget((async()=>{this.started&&await this.wi()})))}wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Pa(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Fi(e).next((e=>{e||(this.isPrimary=!1,this.Ti.enqueueRetryable((()=>this.fi(!1))))}))})).next((()=>this.Mi(e))).next((t=>this.isPrimary&&!t?this.xi(e).next((()=>!1)):!!t&&this.Oi(e).next((()=>!0)))))).catch((e=>{if(we(e))return p(Aa,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return p(Aa,"Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.Ti.enqueueRetryable((()=>this.fi(e))),this.isPrimary=e}))}Fi(e){return Oa(e).get(Pe).next((e=>he.resolve(this.Ni(e))))}Bi(e){return Pa(e).delete(this.clientId)}async Li(){if(this.isPrimary&&!this.ki(this.mi,Ra)){this.mi=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=Bt(e,ft);return t.G().next((e=>{const n=this.qi(e,Ra),r=e.filter((e=>-1===n.indexOf(e)));return he.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.yi)for(const t of e)this.yi.removeItem(this.Qi(t.clientId))}}Di(){this.Vi=this.Ti.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.wi().then((()=>this.Li())).then((()=>this.Di()))))}Ni(e){return!!e&&e.ownerId===this.clientId}Mi(e){return this.Ei?he.resolve(!0):Oa(e).get(Pe).next((t=>{if(null!==t&&this.ki(t.leaseTimestampMs,Va)&&!this.$i(t.ownerId)){if(this.Ni(t)&&this.networkEnabled)return!0;if(!this.Ni(t)){if(!t.allowTabSynchronization)throw new S(E.FAILED_PRECONDITION,La);return!1}}return!(!this.networkEnabled||!this.inForeground)||Pa(e).G().next((e=>void 0===this.qi(e,Va).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&p(Aa,`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.zr=!1,this.Ui(),this.Vi&&(this.Vi.cancel(),this.Vi=null),this.Ki(),this.Wi(),await this.pi.runTransaction("shutdown","readwrite",[Oe,ft],(e=>{const t=new Ut(e,xe.ae);return this.xi(t).next((()=>this.Bi(t)))})),this.pi.close(),this.Gi()}qi(e,t){return e.filter((e=>this.ki(e.updateTimeMs,t)&&!this.$i(e.clientId)))}zi(){return this.runTransaction("getActiveClients","readonly",(e=>Pa(e).G().next((e=>this.qi(e,Ra).map((e=>e.clientId))))))}get started(){return this.zr}getGlobalsCache(){return this.jr}getMutationQueue(e,t){return Uo.It(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Do(e,this.serializer.Tt.databaseId)}getDocumentOverlayCache(e){return eo.It(this.serializer,e)}getBundleCache(){return this.Yr}runTransaction(e,t,n){p(Aa,"Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=function(e){return 17===e?qt:16===e?Pt:15===e?Ot:14===e?Ft:13===e?Mt:12===e?Lt:11===e?Vt:void I()}(this.di);let i;return this.pi.runTransaction(e,r,s,(r=>(i=new Ut(r,this.Gr?this.Gr.next():xe.ae),"readwrite-primary"===t?this.Fi(i).next((e=>!!e||this.Mi(i))).next((t=>{if(!t)throw y(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ti.enqueueRetryable((()=>this.fi(!1))),new S(E.FAILED_PRECONDITION,ue);return n(i)})).next((e=>this.Oi(i).next((()=>e)))):this.ji(i).next((()=>n(i)))))).then((e=>(i.raiseOnCommittedEvent(),e)))}ji(e){return Oa(e).get(Pe).next((e=>{if(null!==e&&this.ki(e.leaseTimestampMs,Va)&&!this.$i(e.ownerId)&&!this.Ni(e)&&!(this.Ei||this.allowTabSynchronization&&e.allowTabSynchronization))throw new S(E.FAILED_PRECONDITION,La)}))}Oi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Oa(e).put(Pe,t)}static D(){return me.D()}xi(e){const t=Oa(e);return t.get(Pe).next((e=>this.Ni(e)?(p(Aa,"Releasing primary lease."),t.delete(Pe)):he.resolve()))}ki(e,t){const n=Date.now();return!(e<n-t||e>n&&(y(`Detected an update time that is in the future: ${e} > ${n}`),1))}Si(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ri=()=>{this.Ti.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.wi())))},this.document.addEventListener("visibilitychange",this.Ri),this.inForeground="visible"===this.document.visibilityState)}Ki(){this.Ri&&(this.document.removeEventListener("visibilitychange",this.Ri),this.Ri=null)}bi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Ai=()=>{this.Ui();const e=/(?:Version|Mobile)\/1[456]/;(0,o.G6)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ti.enterRestrictedMode(!0),this.Ti.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Ai))}Wi(){this.Ai&&(this.window.removeEventListener("pagehide",this.Ai),this.Ai=null)}$i(e){var t;try{const n=null!==(null===(t=this.yi)||void 0===t?void 0:t.getItem(this.Qi(e)));return p(Aa,`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return y(Aa,"Failed to get zombied client id.",e),!1}}Ui(){if(this.yi)try{this.yi.setItem(this.Qi(this.clientId),String(Date.now()))}catch(e){y("Failed to set zombie client id.",e)}}Gi(){if(this.yi)try{this.yi.removeItem(this.Qi(this.clientId))}catch(e){}}Qi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Oa(e){return Bt(e,Oe)}function Pa(e){return Bt(e,ft)}function qa(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Ua{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Hi=n,this.Ji=r}static Yi(e,t){let n=es(),r=es();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new Ua(e,t.fromCache,n,r)}}class Ba{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class za{constructor(){this.Zi=!1,this.Xi=!1,this.es=100,this.ts=(0,o.G6)()?8:ge((0,o.z$)())>0?6:4}initialize(e,t){this.ns=e,this.indexManager=t,this.Zi=!0}getDocumentsMatchingQuery(e,t,n,r){const s={result:null};return this.rs(e,t).next((e=>{s.result=e})).next((()=>{if(!s.result)return this.ss(e,t,r,n).next((e=>{s.result=e}))})).next((()=>{if(s.result)return;const n=new Ba;return this._s(e,t,n).next((r=>{if(s.result=r,this.Xi)return this.us(e,t,n,r.size)}))})).next((()=>s.result))}us(e,t,n,r){return n.documentReadCount<this.es?(m()<=i.in.DEBUG&&p("QueryEngine","SDK will not create cache indexes for query:",Pr(t),"since it only creates cache indexes for collection contains","more than or equal to",this.es,"documents"),he.resolve()):(m()<=i.in.DEBUG&&p("QueryEngine","Query:",Pr(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ts*r?(m()<=i.in.DEBUG&&p("QueryEngine","The SDK decides to create cache indexes for query:",Pr(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Rr(t))):he.resolve())}rs(e,t){if(Dr(t))return he.resolve(null);let n=Rr(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Mr(t,null,"F"),n=Rr(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=es(...r);return this.ns.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.cs(t,r);return this.ls(t,i,s,n.readTime)?this.rs(e,Mr(t,null,"F")):this.hs(e,i,t,n)}))))})))))}ss(e,t,n,r){return Dr(t)||r.isEqual(G.min())?he.resolve(null):this.ns.getDocuments(e,n).next((s=>{const o=this.cs(t,s);return this.ls(t,o,n,r)?he.resolve(null):(m()<=i.in.DEBUG&&p("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Pr(t)),this.hs(e,o,t,se(r,J)).next((e=>e)))}))}cs(e,t){let n=new Wt(Br(e));return t.forEach(((t,r)=>{qr(e,r)&&(n=n.add(r))})),n}ls(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}_s(e,t,n){return m()<=i.in.DEBUG&&p("QueryEngine","Using full collection scan to execute query:",Pr(t)),this.ns.getDocumentsMatchingQuery(e,t,oe.min(),n)}hs(e,t,n,r){return this.ns.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}const $a="LocalStore",Ka=3e8;class Ga{constructor(e,t,n,r){this.persistence=e,this.Ps=t,this.serializer=r,this.Ts=new Gt(P),this.Is=new $r((e=>Ir(e)),_r),this.Es=new Map,this.ds=e.getRemoteDocumentCache(),this.Hr=e.getTargetCache(),this.Yr=e.getBundleCache(),this.As(n)}As(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new ga(this.ds,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ds.setIndexManager(this.indexManager),this.Ps.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ts)))}}function ja(e,t,n,r){return new Ga(e,t,n,r)}async function Qa(e,t){const n=b(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n.As(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=es();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({Rs:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Wa(e){const t=b(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Hr.getLastRemoteSnapshotVersion(e)))}function Ha(e,t,n){let r=es(),s=es();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Gr();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(G.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):p($a,"Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Vs:r,fs:s}}))}function Ya(e,t){const n=b(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=Ne),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Za(e,t){const n=b(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Hr.getTargetData(e,t).next((s=>s?(r=s,he.resolve(r)):n.Hr.allocateTargetId(e).next((s=>(r=new Pi(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Hr.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.Ts.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Ts=n.Ts.insert(e.targetId,e),n.Is.set(t,e.targetId)),e}))}async function Ja(e,t,n){const r=b(e),s=r.Ts.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!we(e))throw e;p($a,`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ts=r.Ts.remove(t),r.Is.delete(s.target)}function Xa(e,t,n){const r=b(e);let s=G.min(),i=es();return r.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const r=b(e),s=r.Is.get(n);return void 0!==s?he.resolve(r.Ts.get(s)):r.Hr.getTargetData(t,n)}(r,e,Rr(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Hr.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.Ps.getDocumentsMatchingQuery(e,t,n?s:G.min(),n?i:es()))).next((e=>(nu(r,Ur(t),e),{documents:e,gs:i})))))}function eu(e,t){const n=b(e),r=b(n.Hr),s=n.Ts.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.lt(e,t).next((e=>e?e.target:null))))}function tu(e,t){const n=b(e),r=n.Es.get(t)||G.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.ds.getAllFromCollectionGroup(e,t,se(r,J),Number.MAX_SAFE_INTEGER))).then((e=>(nu(n,t,e),e)))}function nu(e,t,n){let r=e.Es.get(t)||G.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Es.set(t,r)}async function ru(e,t,n=es()){const r=await Za(e,Rr(Qi(t.bundledQuery))),s=b(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=di(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Yr.saveNamedQuery(e,t);const o=r.withResumeToken(en.EMPTY_BYTE_STRING,i);return s.Ts=s.Ts.insert(o.targetId,o),s.Hr.updateTargetData(e,o).next((()=>s.Hr.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Hr.addMatchingKeys(e,n,r.targetId))).next((()=>s.Yr.saveNamedQuery(e,t)))}))}const su="firestore_clients";function iu(e,t){return`${su}_${e}_${t}`}const ou="firestore_mutations";function au(e,t,n){let r=`${ou}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}const uu="firestore_targets";function cu(e,t){return`${uu}_${e}_${t}`}const lu="SharedClientState";class hu{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ss(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new hu(e,t,r.state,s):(y(lu,`Failed to parse mutation state for ID '${t}': ${n}`),null)}bs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class du{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ss(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new du(e,n.state,r):(y(lu,`Failed to parse target state for ID '${e}': ${t}`),null)}bs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class fu{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ss(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=ns();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=Ce(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new fu(e,s):(y(lu,`Failed to parse client data for instance '${e}': ${t}`),null)}}class mu{constructor(e,t){this.clientId=e,this.onlineState=t}static Ss(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new mu(t.clientId,t.onlineState):(y(lu,`Failed to parse online state: ${e}`),null)}}class gu{constructor(){this.activeTargetIds=ns()}Ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}bs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class pu{constructor(e,t,n,r,s){this.window=e,this.Ti=t,this.persistenceKey=n,this.Cs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Fs=this.Ms.bind(this),this.xs=new Gt(P),this.started=!1,this.Os=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ns=iu(this.persistenceKey,this.Cs),this.Bs=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.xs=this.xs.insert(this.Cs,new gu),this.Ls=new RegExp(`^${su}_${i}_([^_]*)$`),this.ks=new RegExp(`^${ou}_${i}_(\\d+)(?:_(.*))?$`),this.qs=new RegExp(`^${uu}_${i}_(\\d+)$`),this.Qs=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.$s=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.Fs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.zi();for(const n of e){if(n===this.Cs)continue;const e=this.getItem(iu(this.persistenceKey,n));if(e){const t=fu.Ss(n,e);t&&(this.xs=this.xs.insert(t.clientId,t))}}this.Us();const t=this.storage.getItem(this.Qs);if(t){const e=this.Ks(t);e&&this.Ws(e)}for(const n of this.Os)this.Ms(n);this.Os=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Gs(this.xs)}isActiveQueryTarget(e){let t=!1;return this.xs.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.zs(e,"pending")}updateMutationState(e,t,n){this.zs(e,t,n),this.js(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){const t=this.storage.getItem(cu(this.persistenceKey,e));if(t){const r=du.Ss(e,t);r&&(n=r.state)}}return t&&this.Hs.Ds(e),this.Us(),n}removeLocalQueryTarget(e){this.Hs.vs(e),this.Us()}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(cu(this.persistenceKey,e))}updateQueryState(e,t,n){this.Js(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.js(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Ys(e)}notifyBundleLoaded(e){this.Zs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Fs),this.removeItem(this.Ns),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return p(lu,"READ",e,t),t}setItem(e,t){p(lu,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){p(lu,"REMOVE",e),this.storage.removeItem(e)}Ms(e){const t=e;if(t.storageArea===this.storage){if(p(lu,"EVENT",t.key,t.newValue),t.key===this.Ns)return void y("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ti.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.Ls.test(t.key)){if(null==t.newValue){const e=this.Xs(t.key);return this.eo(e,null)}{const e=this.no(t.key,t.newValue);if(e)return this.eo(e.clientId,e)}}else if(this.ks.test(t.key)){if(null!==t.newValue){const e=this.ro(t.key,t.newValue);if(e)return this.io(e)}}else if(this.qs.test(t.key)){if(null!==t.newValue){const e=this.so(t.key,t.newValue);if(e)return this.oo(e)}}else if(t.key===this.Qs){if(null!==t.newValue){const e=this.Ks(t.newValue);if(e)return this.Ws(e)}}else if(t.key===this.Bs){const e=function(e){let t=xe.ae;if(null!=e)try{const n=JSON.parse(e);_("number"==typeof n),t=n}catch(e){y(lu,"Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==xe.ae&&this.sequenceNumberHandler(e)}else if(t.key===this.$s){const e=this._o(t.newValue);await Promise.all(e.map((e=>this.syncEngine.ao(e))))}}else this.Os.push(t)}))}}get Hs(){return this.xs.get(this.Cs)}Us(){this.setItem(this.Ns,this.Hs.bs())}zs(e,t,n){const r=new hu(this.currentUser,e,t,n),s=au(this.persistenceKey,this.currentUser,e);this.setItem(s,r.bs())}js(e){const t=au(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ys(e){const t={clientId:this.Cs,onlineState:e};this.storage.setItem(this.Qs,JSON.stringify(t))}Js(e,t,n){const r=cu(this.persistenceKey,e),s=new du(e,t,n);this.setItem(r,s.bs())}Zs(e){const t=JSON.stringify(Array.from(e));this.setItem(this.$s,t)}Xs(e){const t=this.Ls.exec(e);return t?t[1]:null}no(e,t){const n=this.Xs(e);return fu.Ss(n,t)}ro(e,t){const n=this.ks.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return hu.Ss(new h(s),r,t)}so(e,t){const n=this.qs.exec(e),r=Number(n[1]);return du.Ss(r,t)}Ks(e){return mu.Ss(e)}_o(e){return JSON.parse(e)}async io(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.uo(e.batchId,e.state,e.error);p(lu,`Ignoring mutation for non-active user ${e.user.uid}`)}oo(e){return this.syncEngine.co(e.targetId,e.state,e.error)}eo(e,t){const n=t?this.xs.insert(e,t):this.xs.remove(e),r=this.Gs(this.xs),s=this.Gs(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.lo(i,o).then((()=>{this.xs=n}))}Ws(e){this.xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Gs(e){let t=ns();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class yu{constructor(){this.ho=new gu,this.Po={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.ho.Ds(e),this.Po[e]||"not-current"}updateQueryState(e,t,n){this.Po[e]=t}removeLocalQueryTarget(e){this.ho.vs(e)}isLocalQueryTarget(e){return this.ho.activeTargetIds.has(e)}clearQueryState(e){delete this.Po[e]}getAllActiveQueryTargets(){return this.ho.activeTargetIds}isActiveQueryTarget(e){return this.ho.activeTargetIds.has(e)}start(){return this.ho=new gu,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class wu{To(e){}shutdown(){}}const vu="ConnectivityMonitor";class Iu{constructor(){this.Io=()=>this.Eo(),this.Ao=()=>this.Ro(),this.Vo=[],this.mo()}To(e){this.Vo.push(e)}shutdown(){window.removeEventListener("online",this.Io),window.removeEventListener("offline",this.Ao)}mo(){window.addEventListener("online",this.Io),window.addEventListener("offline",this.Ao)}Eo(){p(vu,"Network connectivity changed: AVAILABLE");for(const e of this.Vo)e(0)}Ro(){p(vu,"Network connectivity changed: UNAVAILABLE");for(const e of this.Vo)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let _u=null;function Tu(){return null===_u?_u=268435456+Math.round(2147483648*Math.random()):_u++,"0x"+_u.toString(16)}const bu="RestConnection",Eu={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Su{get fo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${n}/databases/${r}`,this.wo=this.databaseId.database===mn?`project_id=${n}`:`project_id=${n}&database_id=${r}`}So(e,t,n,r,s){const i=Tu(),o=this.bo(e,t.toUriEncodedString());p(bu,`Sending RPC '${e}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Do(a,r,s),this.vo(e,o,a,n).then((t=>(p(bu,`Received RPC '${e}' ${i}: `,t),t)),(t=>{throw w(bu,`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t}))}Co(e,t,n,r,s,i){return this.So(e,t,n,r,s)}Do(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+d,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}bo(e,t){const n=Eu[e];return`${this.po}/v1/${t}:${n}`}terminate(){}}class xu{constructor(e){this.Fo=e.Fo,this.Mo=e.Mo}xo(e){this.Oo=e}No(e){this.Bo=e}Lo(e){this.ko=e}onMessage(e){this.qo=e}close(){this.Mo()}send(e){this.Fo(e)}Qo(){this.Oo()}$o(){this.Bo()}Uo(e){this.ko(e)}Ko(e){this.qo(e)}}const Nu="WebChannelConnection";class ku extends Su{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(e,t,n,r){const s=Tu();return new Promise(((i,o)=>{const a=new u.JJ;a.setWithCredentials(!0),a.listenOnce(u.tw.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case u.jK.NO_ERROR:const t=a.getResponseJson();p(Nu,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case u.jK.TIMEOUT:p(Nu,`RPC '${e}' ${s} timed out`),o(new S(E.DEADLINE_EXCEEDED,"Request time out"));break;case u.jK.HTTP_ERROR:const n=a.getStatus();if(p(Nu,`RPC '${e}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(E).indexOf(t)>=0?t:E.UNKNOWN}(t.status);o(new S(e,t.message))}else o(new S(E.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new S(E.UNAVAILABLE,"Connection failed."));break;default:I()}}finally{p(Nu,`RPC '${e}' ${s} completed.`)}}));const c=JSON.stringify(r);p(Nu,`RPC '${e}' ${s} sending request:`,r),a.send(t,"POST",c,n,15)}))}Wo(e,t,n){const r=Tu(),s=[this.po,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=(0,u.UE)(),o=(0,u.FJ)(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(a.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Do(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const l=s.join("");p(Nu,`Creating RPC '${e}' stream ${r}: ${l}`,a);const h=i.createWebChannel(l,a);let d=!1,f=!1;const m=new xu({Fo:t=>{f?p(Nu,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(p(Nu,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),p(Nu,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},Mo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return g(h,u.ii.EventType.OPEN,(()=>{f||(p(Nu,`RPC '${e}' stream ${r} transport opened.`),m.Qo())})),g(h,u.ii.EventType.CLOSE,(()=>{f||(f=!0,p(Nu,`RPC '${e}' stream ${r} transport closed`),m.Uo())})),g(h,u.ii.EventType.ERROR,(t=>{f||(f=!0,w(Nu,`RPC '${e}' stream ${r} transport errored:`,t),m.Uo(new S(E.UNAVAILABLE,"The operation could not be completed")))})),g(h,u.ii.EventType.MESSAGE,(t=>{var n;if(!f){const s=t.data[0];_(!!s);const i=s,o=(null==i?void 0:i.error)||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){p(Nu,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function(e){const t=qs[e];if(void 0!==t)return zs(t)}(t),s=o.message;void 0===n&&(n=E.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),f=!0,m.Uo(new S(n,s)),h.close()}else p(Nu,`RPC '${e}' stream ${r} received:`,s),m.Ko(s)}})),g(o,u.ju.STAT_EVENT,(t=>{t.stat===u.kN.PROXY?p(Nu,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===u.kN.NOPROXY&&p(Nu,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{m.$o()}),0),m}}function Du(){return"undefined"!=typeof window?window:null}function Cu(){return"undefined"!=typeof document?document:null}function Au(e){return new ai(e,!0)}class Ru{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Ti=e,this.timerId=t,this.Go=n,this.zo=r,this.jo=s,this.Ho=0,this.Jo=null,this.Yo=Date.now(),this.reset()}reset(){this.Ho=0}Zo(){this.Ho=this.jo}Xo(e){this.cancel();const t=Math.floor(this.Ho+this.e_()),n=Math.max(0,Date.now()-this.Yo),r=Math.max(0,t-n);r>0&&p("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ho} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Jo=this.Ti.enqueueAfterDelay(this.timerId,r,(()=>(this.Yo=Date.now(),e()))),this.Ho*=this.zo,this.Ho<this.Go&&(this.Ho=this.Go),this.Ho>this.jo&&(this.Ho=this.jo)}t_(){null!==this.Jo&&(this.Jo.skipDelay(),this.Jo=null)}cancel(){null!==this.Jo&&(this.Jo.cancel(),this.Jo=null)}e_(){return(Math.random()-.5)*this.Ho}}const Vu="PersistentStream";class Lu{constructor(e,t,n,r,s,i,o,a){this.Ti=e,this.n_=n,this.r_=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.i_=0,this.s_=null,this.o_=null,this.stream=null,this.__=0,this.a_=new Ru(e,t)}u_(){return 1===this.state||5===this.state||this.c_()}c_(){return 2===this.state||3===this.state}start(){this.__=0,4!==this.state?this.auth():this.l_()}async stop(){this.u_()&&await this.close(0)}h_(){this.state=0,this.a_.reset()}P_(){this.c_()&&null===this.s_&&(this.s_=this.Ti.enqueueAfterDelay(this.n_,6e4,(()=>this.T_())))}I_(e){this.E_(),this.stream.send(e)}async T_(){if(this.c_())return this.close(0)}E_(){this.s_&&(this.s_.cancel(),this.s_=null)}d_(){this.o_&&(this.o_.cancel(),this.o_=null)}async close(e,t){this.E_(),this.d_(),this.a_.cancel(),this.i_++,4!==e?this.a_.reset():t&&t.code===E.RESOURCE_EXHAUSTED?(y(t.toString()),y("Using maximum backoff delay to prevent overloading the backend."),this.a_.Zo()):t&&t.code===E.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.A_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Lo(t)}A_(){}auth(){this.state=1;const e=this.R_(this.i_),t=this.i_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.i_===t&&this.V_(e,n)}),(t=>{e((()=>{const e=new S(E.UNKNOWN,"Fetching auth token failed: "+t.message);return this.m_(e)}))}))}V_(e,t){const n=this.R_(this.i_);this.stream=this.f_(e,t),this.stream.xo((()=>{n((()=>this.listener.xo()))})),this.stream.No((()=>{n((()=>(this.state=2,this.o_=this.Ti.enqueueAfterDelay(this.r_,1e4,(()=>(this.c_()&&(this.state=3),Promise.resolve()))),this.listener.No())))})),this.stream.Lo((e=>{n((()=>this.m_(e)))})),this.stream.onMessage((e=>{n((()=>1==++this.__?this.g_(e):this.onNext(e)))}))}l_(){this.state=5,this.a_.Xo((async()=>{this.state=0,this.start()}))}m_(e){return p(Vu,`close with error: ${e}`),this.stream=null,this.close(4,e)}R_(e){return t=>{this.Ti.enqueueAndForget((()=>this.i_===e?t():(p(Vu,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Mu extends Lu{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}f_(e,t){return this.connection.Wo("Listen",e,t)}g_(e){return this.onNext(e)}onNext(e){this.a_.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:I()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(_(void 0===t||"string"==typeof t),en.fromBase64String(t||"")):(_(void 0===t||t instanceof Buffer||t instanceof Uint8Array),en.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?E.UNKNOWN:zs(e.code);return new S(t,e.message||"")}(o);n=new Xs(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=yi(e,r.document.name),i=di(r.document.updateTime),o=r.document.createTime?di(r.document.createTime):G.min(),a=new Gn({mapValue:{fields:r.document.fields}}),u=Qn.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new Zs(c,l,u.key,u)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=yi(e,r.document),i=r.readTime?di(r.readTime):G.min(),o=Qn.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Zs([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=yi(e,r.document),i=r.removedTargetIds||[];n=new Zs([],i,s,null)}else{if(!("filter"in t))return I();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new Ps(r,s),o=e.targetId;n=new Js(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return G.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?G.min():t.readTime?di(t.readTime):G.min()}(e);return this.listener.p_(t,n)}y_(e){const t={};t.database=Ii(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=Tr(r)?{documents:xi(e,r)}:{query:Ni(e,r).ht},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=li(e,t.resumeToken);const r=ui(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(G.min())>0){n.readTime=ci(e,t.snapshotVersion.toTimestamp());const r=ui(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return I()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.I_(t)}w_(e){const t={};t.database=Ii(this.serializer),t.removeTarget=e,this.I_(t)}}class Fu extends Lu{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}get S_(){return this.__>0}start(){this.lastStreamToken=void 0,super.start()}A_(){this.S_&&this.b_([])}f_(e,t){return this.connection.Wo("Write",e,t)}g_(e){return _(!!e.streamToken),this.lastStreamToken=e.streamToken,_(!e.writeResults||0===e.writeResults.length),this.listener.D_()}onNext(e){_(!!e.streamToken),this.lastStreamToken=e.streamToken,this.a_.reset();const t=function(e,t){return e&&e.length>0?(_(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?di(e.updateTime):di(t);return n.isEqual(G.min())&&(n=di(t)),new vs(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=di(e.commitTime);return this.listener.v_(n,t)}C_(){const e={};e.database=Ii(this.serializer),this.I_(e)}b_(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Ei(this.serializer,e)))};this.I_(t)}}class Ou{}class Pu extends Ou{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.F_=!1}M_(){if(this.F_)throw new S(E.FAILED_PRECONDITION,"The client has already been terminated.")}So(e,t,n,r){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.So(e,mi(t,n),r,s,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(E.UNKNOWN,e.toString())}))}Co(e,t,n,r,s){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,o])=>this.connection.Co(e,mi(t,n),r,i,o,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(E.UNKNOWN,e.toString())}))}terminate(){this.F_=!0,this.connection.terminate()}}class qu{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.x_=0,this.O_=null,this.N_=!0}B_(){0===this.x_&&(this.L_("Unknown"),this.O_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.O_=null,this.k_("Backend didn't respond within 10 seconds."),this.L_("Offline"),Promise.resolve()))))}q_(e){"Online"===this.state?this.L_("Unknown"):(this.x_++,this.x_>=1&&(this.Q_(),this.k_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.L_("Offline")))}set(e){this.Q_(),this.x_=0,"Online"===e&&(this.N_=!1),this.L_(e)}L_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}k_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.N_?(y(t),this.N_=!1):p("OnlineStateTracker",t)}Q_(){null!==this.O_&&(this.O_.cancel(),this.O_=null)}}const Uu="RemoteStore";class Bu{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.U_=[],this.K_=new Map,this.W_=new Set,this.G_=[],this.z_=s,this.z_.To((e=>{n.enqueueAndForget((async()=>{Yu(this)&&(p(Uu,"Restarting streams for network reachability change."),await async function(e){const t=b(e);t.W_.add(4),await $u(t),t.j_.set("Unknown"),t.W_.delete(4),await zu(t)}(this))}))})),this.j_=new qu(n,r)}}async function zu(e){if(Yu(e))for(const t of e.G_)await t(!0)}async function $u(e){for(const t of e.G_)await t(!1)}function Ku(e,t){const n=b(e);n.K_.has(t.targetId)||(n.K_.set(t.targetId,t),Hu(n)?Wu(n):gc(n).c_()&&ju(n,t))}function Gu(e,t){const n=b(e),r=gc(n);n.K_.delete(t),r.c_()&&Qu(n,t),0===n.K_.size&&(r.c_()?r.P_():Yu(n)&&n.j_.set("Unknown"))}function ju(e,t){if(e.H_.Ne(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(G.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}gc(e).y_(t)}function Qu(e,t){e.H_.Ne(t),gc(e).w_(t)}function Wu(e){e.H_=new ti({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),lt:t=>e.K_.get(t)||null,it:()=>e.datastore.serializer.databaseId}),gc(e).start(),e.j_.B_()}function Hu(e){return Yu(e)&&!gc(e).u_()&&e.K_.size>0}function Yu(e){return 0===b(e).W_.size}function Zu(e){e.H_=void 0}async function Ju(e){e.j_.set("Online")}async function Xu(e){e.K_.forEach(((t,n)=>{ju(e,t)}))}async function ec(e,t){Zu(e),Hu(e)?(e.j_.q_(t),Wu(e)):e.j_.set("Unknown")}async function tc(e,t,n){if(e.j_.set("Online"),t instanceof Xs&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.K_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.K_.delete(r),e.H_.removeTarget(r))}(e,t)}catch(n){p(Uu,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await nc(e,n)}else if(t instanceof Zs?e.H_.We(t):t instanceof Js?e.H_.Ze(t):e.H_.je(t),!n.isEqual(G.min()))try{const t=await Wa(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.H_.ot(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.K_.get(r);s&&e.K_.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.K_.get(t);if(!r)return;e.K_.set(t,r.withResumeToken(en.EMPTY_BYTE_STRING,r.snapshotVersion)),Qu(e,t);const s=new Pi(r.target,t,n,r.sequenceNumber);ju(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){p(Uu,"Failed to raise snapshot:",t),await nc(e,t)}}async function nc(e,t,n){if(!we(t))throw t;e.W_.add(1),await $u(e),e.j_.set("Offline"),n||(n=()=>Wa(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{p(Uu,"Retrying IndexedDB access"),await n(),e.W_.delete(1),await zu(e)}))}function rc(e,t){return t().catch((n=>nc(e,n,t)))}async function sc(e){const t=b(e),n=pc(t);let r=t.U_.length>0?t.U_[t.U_.length-1].batchId:Ne;for(;ic(t);)try{const e=await Ya(t.localStore,r);if(null===e){0===t.U_.length&&n.P_();break}r=e.batchId,oc(t,e)}catch(e){await nc(t,e)}ac(t)&&uc(t)}function ic(e){return Yu(e)&&e.U_.length<10}function oc(e,t){e.U_.push(t);const n=pc(e);n.c_()&&n.S_&&n.b_(t.mutations)}function ac(e){return Yu(e)&&!pc(e).u_()&&e.U_.length>0}function uc(e){pc(e).start()}async function cc(e){pc(e).C_()}async function lc(e){const t=pc(e);for(const n of e.U_)t.b_(n.mutations)}async function hc(e,t,n){const r=e.U_.shift(),s=Fs.from(r,t,n);await rc(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await sc(e)}async function dc(e,t){t&&pc(e).S_&&await async function(e,t){if(function(e){return Bs(e)&&e!==E.ABORTED}(t.code)){const n=e.U_.shift();pc(e).h_(),await rc(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await sc(e)}}(e,t),ac(e)&&uc(e)}async function fc(e,t){const n=b(e);n.asyncQueue.verifyOperationInProgress(),p(Uu,"RemoteStore received new credentials");const r=Yu(n);n.W_.add(3),await $u(n),r&&n.j_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.W_.delete(3),await zu(n)}async function mc(e,t){const n=b(e);t?(n.W_.delete(2),await zu(n)):t||(n.W_.add(2),await $u(n),n.j_.set("Unknown"))}function gc(e){return e.J_||(e.J_=function(e,t,n){const r=b(e);return r.M_(),new Mu(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{xo:Ju.bind(null,e),No:Xu.bind(null,e),Lo:ec.bind(null,e),p_:tc.bind(null,e)}),e.G_.push((async t=>{t?(e.J_.h_(),Hu(e)?Wu(e):e.j_.set("Unknown")):(await e.J_.stop(),Zu(e))}))),e.J_}function pc(e){return e.Y_||(e.Y_=function(e,t,n){const r=b(e);return r.M_(),new Fu(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{xo:()=>Promise.resolve(),No:cc.bind(null,e),Lo:dc.bind(null,e),D_:lc.bind(null,e),v_:hc.bind(null,e)}),e.G_.push((async t=>{t?(e.Y_.h_(),await sc(e)):(await e.Y_.stop(),e.U_.length>0&&(p(Uu,`Stopping write stream with ${e.U_.length} pending writes`),e.U_=[]))}))),e.Y_}class yc{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new x,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new yc(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(E.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function wc(e,t){if(y("AsyncQueue",`${t}: ${e}`),we(e))return new S(E.UNAVAILABLE,`${t}: ${e}`);throw e}class vc{static emptySet(e){return new vc(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||Z.comparator(t.key,n.key):(e,t)=>Z.comparator(e.key,t.key),this.keyedMap=Qr(),this.sortedSet=new Gt(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof vc))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new vc;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Ic{constructor(){this.Z_=new Gt(Z.comparator)}track(e){const t=e.doc.key,n=this.Z_.get(t);n?0!==e.type&&3===n.type?this.Z_=this.Z_.insert(t,e):3===e.type&&1!==n.type?this.Z_=this.Z_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Z_=this.Z_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Z_=this.Z_.remove(t):1===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):I():this.Z_=this.Z_.insert(t,e)}X_(){const e=[];return this.Z_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class _c{constructor(e,t,n,r,s,i,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new _c(e,t,vc.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Fr(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Tc{constructor(){this.ea=void 0,this.ta=[]}na(){return this.ta.some((e=>e.ra()))}}class bc{constructor(){this.queries=Ec(),this.onlineState="Unknown",this.ia=new Set}terminate(){!function(e,t){const n=b(e),r=n.queries;n.queries=Ec(),r.forEach(((e,n)=>{for(const r of n.ta)r.onError(t)}))}(this,new S(E.ABORTED,"Firestore shutting down"))}}function Ec(){return new $r((e=>Or(e)),Fr)}async function Sc(e,t){const n=b(e);let r=3;const s=t.query;let i=n.queries.get(s);i?!i.na()&&t.ra()&&(r=2):(i=new Tc,r=t.ra()?0:1);try{switch(r){case 0:i.ea=await n.onListen(s,!0);break;case 1:i.ea=await n.onListen(s,!1);break;case 2:await n.onFirstRemoteStoreListen(s)}}catch(e){const n=wc(e,`Initialization of query '${Pr(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,i),i.ta.push(t),t.sa(n.onlineState),i.ea&&t.oa(i.ea)&&Dc(n)}async function xc(e,t){const n=b(e),r=t.query;let s=3;const i=n.queries.get(r);if(i){const e=i.ta.indexOf(t);e>=0&&(i.ta.splice(e,1),0===i.ta.length?s=t.ra()?0:1:!i.na()&&t.ra()&&(s=2))}switch(s){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function Nc(e,t){const n=b(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.ta)e.oa(s)&&(r=!0);t.ea=s}}r&&Dc(n)}function kc(e,t,n){const r=b(e),s=r.queries.get(t);if(s)for(const i of s.ta)i.onError(n);r.queries.delete(t)}function Dc(e){e.ia.forEach((e=>{e.next()}))}var Cc,Ac;(Ac=Cc||(Cc={}))._a="default",Ac.Cache="cache";class Rc{constructor(e,t,n){this.query=e,this.aa=t,this.ua=!1,this.ca=null,this.onlineState="Unknown",this.options=n||{}}oa(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new _c(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.ua?this.la(e)&&(this.aa.next(e),t=!0):this.ha(e,this.onlineState)&&(this.Pa(e),t=!0),this.ca=e,t}onError(e){this.aa.error(e)}sa(e){this.onlineState=e;let t=!1;return this.ca&&!this.ua&&this.ha(this.ca,e)&&(this.Pa(this.ca),t=!0),t}ha(e,t){if(!e.fromCache)return!0;if(!this.ra())return!0;const n="Offline"!==t;return(!this.options.Ta||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}la(e){if(e.docChanges.length>0)return!0;const t=this.ca&&this.ca.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Pa(e){e=_c.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.ua=!0,this.aa.next(e)}ra(){return this.options.source!==Cc.Cache}}class Vc{constructor(e,t){this.Ia=e,this.byteLength=t}Ea(){return"metadata"in this.Ia}}class Lc{constructor(e){this.serializer=e}ps(e){return yi(this.serializer,e)}ys(e){return e.metadata.exists?bi(this.serializer,e.document,!1):Qn.newNoDocument(this.ps(e.metadata.name),this.ws(e.metadata.readTime))}ws(e){return di(e)}}class Mc{constructor(e,t,n){this.da=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Fc(e)}Aa(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Ia.namedQuery)this.queries.push(e.Ia.namedQuery);else if(e.Ia.documentMetadata){this.documents.push({metadata:e.Ia.documentMetadata}),e.Ia.documentMetadata.exists||++t;const n=W.fromString(e.Ia.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Ia.document&&(this.documents[this.documents.length-1].document=e.Ia.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Ra(e){const t=new Map,n=new Lc(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.ps(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||es()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=b(e);let i=es(),o=Gr();for(const c of n){const e=t.ps(c.metadata.name);c.document&&(i=i.add(e));const n=t.ys(c);n.setReadTime(t.ws(c.metadata.readTime)),o=o.insert(e,n)}const a=s.ds.newChangeBuffer({trackRemovals:!0}),u=await Za(s,function(e){return Rr(kr(W.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Ha(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Hr.removeMatchingKeysForTargetId(e,u.targetId).next((()=>s.Hr.addMatchingKeys(e,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.Vs,t.fs))).next((()=>t.Vs))))))}(this.localStore,new Lc(this.serializer),this.documents,this.da.id),t=this.Ra(this.documents);for(const n of this.queries)await ru(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Va:this.collectionGroups,ma:e}}}function Fc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Oc{constructor(e){this.key=e}}class Pc{constructor(e){this.key=e}}class qc{constructor(e,t){this.query=e,this.fa=t,this.ga=null,this.hasCachedResults=!1,this.current=!1,this.pa=es(),this.mutatedKeys=es(),this.ya=Br(e),this.wa=new vc(this.ya)}get Sa(){return this.fa}ba(e,t){const n=t?t.Da:new Ic,r=t?t.wa:this.wa;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const c=r.get(e),l=qr(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.va(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.ya(l,a)>0||u&&this.ya(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{wa:i,Da:n,ls:o,mutatedKeys:s}}va(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const s=this.wa;this.wa=e.wa,this.mutatedKeys=e.mutatedKeys;const i=e.Da.X_();i.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return I()}};return n(e)-n(t)}(e.type,t.type)||this.ya(e.doc,t.doc))),this.Ca(n),r=null!=r&&r;const o=t&&!r?this.Fa():[],a=0===this.pa.size&&this.current&&!r?1:0,u=a!==this.ga;return this.ga=a,0!==i.length||u?{snapshot:new _c(this.query,e.wa,s,i,e.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),Ma:o}:{Ma:o}}sa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({wa:this.wa,Da:new Ic,mutatedKeys:this.mutatedKeys,ls:!1},!1)):{Ma:[]}}xa(e){return!this.fa.has(e)&&!!this.wa.has(e)&&!this.wa.get(e).hasLocalMutations}Ca(e){e&&(e.addedDocuments.forEach((e=>this.fa=this.fa.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.fa=this.fa.delete(e))),this.current=e.current)}Fa(){if(!this.current)return[];const e=this.pa;this.pa=es(),this.wa.forEach((e=>{this.xa(e.key)&&(this.pa=this.pa.add(e.key))}));const t=[];return e.forEach((e=>{this.pa.has(e)||t.push(new Pc(e))})),this.pa.forEach((n=>{e.has(n)||t.push(new Oc(n))})),t}Oa(e){this.fa=e.gs,this.pa=es();const t=this.ba(e.documents);return this.applyChanges(t,!0)}Na(){return _c.fromInitialDocuments(this.query,this.wa,this.mutatedKeys,0===this.ga,this.hasCachedResults)}}const Uc="SyncEngine";class Bc{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class zc{constructor(e){this.key=e,this.Ba=!1}}class $c{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.La={},this.ka=new $r((e=>Or(e)),Fr),this.qa=new Map,this.Qa=new Set,this.$a=new Gt(Z.comparator),this.Ua=new Map,this.Ka=new va,this.Wa={},this.Ga=new Map,this.za=Go.Kn(),this.onlineState="Unknown",this.ja=void 0}get isPrimaryClient(){return!0===this.ja}}async function Kc(e,t,n=!0){const r=vl(e);let s;const i=r.ka.get(t);return i?(r.sharedClientState.addLocalQueryTarget(i.targetId),s=i.view.Na()):s=await jc(r,t,n,!0),s}async function Gc(e,t){const n=vl(e);await jc(n,t,!0,!1)}async function jc(e,t,n,r){const s=await Za(e.localStore,Rr(t)),i=s.targetId,o=e.sharedClientState.addLocalQueryTarget(i,n);let a;return r&&(a=await Qc(e,t,i,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&Ku(e.remoteStore,s),a}async function Qc(e,t,n,r,s){e.Ha=(t,n,r)=>async function(e,t,n,r){let s=t.view.ba(n);s.ls&&(s=await Xa(e.localStore,t.query,!1).then((({documents:e})=>t.view.ba(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(s,e.isPrimaryClient,i,o);return il(e,t.targetId,a.Ma),a.snapshot}(e,t,n,r);const i=await Xa(e.localStore,t,!0),o=new qc(t,i.gs),a=o.ba(i.documents),u=Ys.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),c=o.applyChanges(a,e.isPrimaryClient,u);il(e,n,c.Ma);const l=new Bc(t,n,o);return e.ka.set(t,l),e.qa.has(n)?e.qa.get(n).push(t):e.qa.set(n,[t]),c.snapshot}async function Wc(e,t,n){const r=b(e),s=r.ka.get(t),i=r.qa.get(s.targetId);if(i.length>1)return r.qa.set(s.targetId,i.filter((e=>!Fr(e,t)))),void r.ka.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(s.targetId),r.sharedClientState.isActiveQueryTarget(s.targetId)||await Ja(r.localStore,s.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(s.targetId),n&&Gu(r.remoteStore,s.targetId),rl(r,s.targetId)})).catch(le)):(rl(r,s.targetId),await Ja(r.localStore,s.targetId,!0))}async function Hc(e,t){const n=b(e),r=n.ka.get(t),s=n.qa.get(r.targetId);n.isPrimaryClient&&1===s.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),Gu(n.remoteStore,r.targetId))}async function Yc(e,t){const n=b(e);try{const e=await function(e,t){const n=b(e),r=t.snapshotVersion;let s=n.Ts;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.ds.newChangeBuffer({trackRemovals:!0});s=n.Ts;const o=[];t.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Hr.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Hr.addMatchingKeys(e,i.addedDocuments,a))));let c=u.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?c=c.withResumeToken(en.EMPTY_BYTE_STRING,G.min()).withLastLimboFreeSnapshotVersion(G.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||(t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=Ka||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0)}(u,c,i)&&o.push(n.Hr.updateTargetData(e,c))}));let a=Gr(),u=es();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(Ha(e,i,t.documentUpdates).next((e=>{a=e.Vs,u=e.fs}))),!r.isEqual(G.min())){const t=n.Hr.getLastRemoteSnapshotVersion(e).next((t=>n.Hr.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return he.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,u))).next((()=>a))})).then((e=>(n.Ts=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Ua.get(t);r&&(_(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.Ba=!0:e.modifiedDocuments.size>0?_(r.Ba):e.removedDocuments.size>0&&(_(r.Ba),r.Ba=!1))})),await ul(n,e,t)}catch(e){await le(e)}}function Zc(e,t,n){const r=b(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ka.forEach(((n,r)=>{const s=r.view.sa(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=b(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.ta)s.sa(t)&&(r=!0)})),r&&Dc(n)}(r.eventManager,t),e.length&&r.La.p_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Jc(e,t,n){const r=b(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Ua.get(t),i=s&&s.key;if(i){let e=new Gt(Z.comparator);e=e.insert(i,Qn.newNoDocument(i,G.min()));const n=es().add(i),s=new Hs(G.min(),new Map,new Gt(P),e,n);await Yc(r,s),r.$a=r.$a.remove(i),r.Ua.delete(t),al(r)}else await Ja(r.localStore,t,!1).then((()=>rl(r,t,n))).catch(le)}async function Xc(e,t){const n=b(e),r=t.batch.batchId;try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.ds.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=he.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);_(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=es();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);nl(n,r,null),tl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await ul(n,e)}catch(e){await le(e)}}async function el(e,t,n){const r=b(e);try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(_(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);nl(r,t,n),tl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await ul(r,e)}catch(n){await le(n)}}function tl(e,t){(e.Ga.get(t)||[]).forEach((e=>{e.resolve()})),e.Ga.delete(t)}function nl(e,t,n){const r=b(e);let s=r.Wa[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Wa[r.currentUser.toKey()]=s}}function rl(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.qa.get(t))e.ka.delete(r),n&&e.La.Ja(r,n);e.qa.delete(t),e.isPrimaryClient&&e.Ka.br(t).forEach((t=>{e.Ka.containsKey(t)||sl(e,t)}))}function sl(e,t){e.Qa.delete(t.path.canonicalString());const n=e.$a.get(t);null!==n&&(Gu(e.remoteStore,n),e.$a=e.$a.remove(t),e.Ua.delete(n),al(e))}function il(e,t,n){for(const r of n)r instanceof Oc?(e.Ka.addReference(r.key,t),ol(e,r)):r instanceof Pc?(p(Uc,"Document no longer in limbo: "+r.key),e.Ka.removeReference(r.key,t),e.Ka.containsKey(r.key)||sl(e,r.key)):I()}function ol(e,t){const n=t.key,r=n.path.canonicalString();e.$a.get(n)||e.Qa.has(r)||(p(Uc,"New document in limbo: "+n),e.Qa.add(r),al(e))}function al(e){for(;e.Qa.size>0&&e.$a.size<e.maxConcurrentLimboResolutions;){const t=e.Qa.values().next().value;e.Qa.delete(t);const n=new Z(W.fromString(t)),r=e.za.next();e.Ua.set(r,new zc(n)),e.$a=e.$a.insert(n,r),Ku(e.remoteStore,new Pi(Rr(kr(n.path)),r,"TargetPurposeLimboResolution",xe.ae))}}async function ul(e,t,n){const r=b(e),s=[],i=[],o=[];r.ka.isEmpty()||(r.ka.forEach(((e,a)=>{o.push(r.Ha(a,t,n).then((e=>{var t;if((e||n)&&r.isPrimaryClient){const s=e?!e.fromCache:null===(t=null==n?void 0:n.targetChanges.get(a.targetId))||void 0===t?void 0:t.current;r.sharedClientState.updateQueryState(a.targetId,s?"current":"not-current")}if(e){s.push(e);const t=Ua.Yi(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.La.p_(s),await async function(e,t){const n=b(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>he.forEach(t,(t=>he.forEach(t.Hi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>he.forEach(t.Ji,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!we(e))throw e;p($a,"Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.Ts.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.Ts=n.Ts.insert(e,s)}}}(r.localStore,i))}async function cl(e,t){const n=b(e);if(!n.currentUser.isEqual(t)){p(Uc,"User change. New user:",t.toKey());const e=await Qa(n.localStore,t);n.currentUser=t,function(e,t){e.Ga.forEach((e=>{e.forEach((e=>{e.reject(new S(E.CANCELLED,t))}))})),e.Ga.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await ul(n,e.Rs)}}function ll(e,t){const n=b(e),r=n.Ua.get(t);if(r&&r.Ba)return es().add(r.key);{let e=es();const r=n.qa.get(t);if(!r)return e;for(const t of r){const r=n.ka.get(t);e=e.unionWith(r.view.Sa)}return e}}async function hl(e,t){const n=b(e),r=await Xa(n.localStore,t.query,!0),s=t.view.Oa(r);return n.isPrimaryClient&&il(n,t.targetId,s.Ma),s}async function dl(e,t){const n=b(e);return tu(n.localStore,t).then((e=>ul(n,e)))}async function fl(e,t,n,r){const s=b(e),i=await function(e,t){const n=b(e),r=b(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.Ln(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):he.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await sc(s.remoteStore):"acknowledged"===n||"rejected"===n?(nl(s,t,r||null),tl(s,t),function(e,t){b(b(e).mutationQueue).qn(t)}(s.localStore,t)):I(),await ul(s,i)):p(Uc,"Cannot apply mutation batch with id: "+t)}async function ml(e,t,n){const r=b(e),s=[],i=[];for(const o of t){let e;const t=r.qa.get(o);if(t&&0!==t.length){e=await Za(r.localStore,Rr(t[0]));for(const e of t){const t=r.ka.get(e),n=await hl(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await eu(r.localStore,o);e=await Za(r.localStore,t),await Qc(r,gl(t),o,!1,e.resumeToken)}s.push(e)}return r.La.p_(i),s}function gl(e){return Nr(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function pl(e){return function(e){return b(b(e).persistence).zi()}(b(e).localStore)}async function yl(e,t,n,r){const s=b(e);if(s.ja)return void p(Uc,"Ignoring unexpected query state notification.");const i=s.qa.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await tu(s.localStore,Ur(i[0])),r=Hs.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,en.EMPTY_BYTE_STRING);await ul(s,e,r);break}case"rejected":await Ja(s.localStore,t,!0),rl(s,t,r);break;default:I()}}async function wl(e,t,n){const r=vl(e);if(r.ja){for(const e of t){if(r.qa.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){p(Uc,"Adding an already active target "+e);continue}const t=await eu(r.localStore,e),n=await Za(r.localStore,t);await Qc(r,gl(t),n.targetId,!1,n.resumeToken),Ku(r.remoteStore,n)}for(const e of n)r.qa.has(e)&&await Ja(r.localStore,e,!1).then((()=>{Gu(r.remoteStore,e),rl(r,e)})).catch(le)}}function vl(e){const t=b(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Yc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=ll.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Jc.bind(null,t),t.La.p_=Nc.bind(null,t.eventManager),t.La.Ja=kc.bind(null,t.eventManager),t}function Il(e){const t=b(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Xc.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=el.bind(null,t),t}class _l{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=Au(e.databaseInfo.databaseId),this.sharedClientState=this.Za(e),this.persistence=this.Xa(e),await this.persistence.start(),this.localStore=this.eu(e),this.gcScheduler=this.tu(e,this.localStore),this.indexBackfillerScheduler=this.nu(e,this.localStore)}tu(e,t){return null}nu(e,t){return null}eu(e){return ja(this.persistence,new za,e.initialUser,this.serializer)}Xa(e){return new Sa(Na.ri,this.serializer)}Za(e){return new yu}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}_l.provider={build:()=>new _l};class Tl extends _l{constructor(e){super(),this.cacheSizeBytes=e}tu(e,t){_(this.persistence.referenceDelegate instanceof ka);const n=this.persistence.referenceDelegate.garbageCollector;return new ea(n,e.asyncQueue,t)}Xa(e){const t=void 0!==this.cacheSizeBytes?Oo.withCacheSize(this.cacheSizeBytes):Oo.DEFAULT;return new Sa((e=>ka.ri(e,t)),this.serializer)}}class bl extends _l{constructor(e,t,n){super(),this.ru=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.ru.initialize(this,e),await Il(this.ru.syncEngine),await sc(this.ru.remoteStore),await this.persistence.Ci((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}eu(e){return ja(this.persistence,new za,e.initialUser,this.serializer)}tu(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new ea(n,e.asyncQueue,t)}nu(e,t){const n=new Se(t,this.persistence);return new Ee(e.asyncQueue,n)}Xa(e){const t=qa(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Oo.withCacheSize(this.cacheSizeBytes):Oo.DEFAULT;return new Fa(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Du(),Cu(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Za(e){return new yu}}class El extends bl{constructor(e,t){super(e,t,!1),this.ru=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.ru.syncEngine;this.sharedClientState instanceof pu&&(this.sharedClientState.syncEngine={uo:fl.bind(null,t),co:yl.bind(null,t),lo:wl.bind(null,t),zi:pl.bind(null,t),ao:dl.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ci((async e=>{await async function(e,t){const n=b(e);if(vl(n),Il(n),!0===t&&!0!==n.ja){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await ml(n,e.toArray());n.ja=!0,await mc(n.remoteStore,!0);for(const r of t)Ku(n.remoteStore,r)}else if(!1===t&&!1!==n.ja){const e=[];let t=Promise.resolve();n.qa.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(rl(n,s),Ja(n.localStore,s,!0)))),Gu(n.remoteStore,s)})),await t,await ml(n,e),function(e){const t=b(e);t.Ua.forEach(((e,n)=>{Gu(t.remoteStore,n)})),t.Ka.Dr(),t.Ua=new Map,t.$a=new Gt(Z.comparator)}(n),n.ja=!1,await mc(n.remoteStore,!1)}}(this.ru.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}Za(e){const t=Du();if(!pu.D(t))throw new S(E.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=qa(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new pu(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Sl{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Zc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=cl.bind(null,this.syncEngine),await mc(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new bc}createDatastore(e){const t=Au(e.databaseInfo.databaseId),n=function(e){return new ku(e)}(e.databaseInfo);return function(e,t,n,r){return new Pu(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,r,s){return new Bu(e,t,n,r,s)}(this.localStore,this.datastore,e.asyncQueue,(e=>Zc(this.syncEngine,e,0)),Iu.D()?new Iu:new wu)}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new $c(e,t,n,r,s,i);return o&&(a.ja=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){const t=b(e);p(Uu,"RemoteStore shutting down."),t.W_.add(5),await $u(t),t.z_.shutdown(),t.j_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate(),null===(t=this.eventManager)||void 0===t||t.terminate()}}function xl(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}Sl.provider={build:()=>new Sl};class Nl{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.iu(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.iu(this.observer.error,e):y("Uncaught Error in snapshot listener:",e.toString()))}su(){this.muted=!0}iu(e,t){setTimeout((()=>{this.muted||e(t)}),0)}}class kl{constructor(e,t){this.ou=e,this.serializer=t,this.metadata=new x,this.buffer=new Uint8Array,this._u=new TextDecoder("utf-8"),this.au().then((e=>{e&&e.Ea()?this.metadata.resolve(e.Ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Ia)}`))}),(e=>this.metadata.reject(e)))}close(){return this.ou.cancel()}async getMetadata(){return this.metadata.promise}async Ya(){return await this.getMetadata(),this.au()}async au(){const e=await this.uu();if(null===e)return null;const t=this._u.decode(e),n=Number(t);isNaN(n)&&this.cu(`length string (${t}) is not valid number`);const r=await this.lu(n);return new Vc(JSON.parse(r),e.length+n)}hu(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async uu(){for(;this.hu()<0&&!await this.Pu(););if(0===this.buffer.length)return null;const e=this.hu();e<0&&this.cu("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async lu(e){for(;this.buffer.length<e;)await this.Pu()&&this.cu("Reached the end of bundle when more is expected.");const t=this._u.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}cu(e){throw this.ou.cancel(),new Error(`Invalid bundle format: ${e}`)}async Pu(){const e=await this.ou.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Dl{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new S(E.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function(e,t){const n=b(e),r={documents:t.map((e=>pi(n.serializer,e)))},s=await n.Co("BatchGetDocuments",n.serializer.databaseId,W.emptyPath(),r,t.length),i=new Map;s.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){_(!!t.found),t.found.name,t.found.updateTime;const n=yi(e,t.found.name),r=di(t.found.updateTime),s=t.found.createTime?di(t.found.createTime):G.min(),i=new Gn({mapValue:{fields:t.found.fields}});return Qn.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){_(!!t.missing),_(!!t.readTime);const n=yi(e,t.missing),r=di(t.readTime);return Qn.newNoDocument(n,r)}(e,t):I()}(n.serializer,e);i.set(t.key.toString(),t)}));const o=[];return t.forEach((e=>{const t=i.get(e.toString());_(!!t),o.push(t)})),o}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Vs(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=Z.fromPath(t);this.mutations.push(new Ls(n,this.precondition(n)))})),await async function(e,t){const n=b(e),r={writes:t.map((e=>Ei(n.serializer,e)))};await n.So("Commit",n.serializer.databaseId,W.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw I();t=G.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new S(E.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(G.min())?Is.exists(!1):Is.updateTime(t):Is.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(G.min()))throw new S(E.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Is.updateTime(t)}return Is.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Cl{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Tu=n.maxAttempts,this.a_=new Ru(this.asyncQueue,"transaction_retry")}Iu(){this.Tu-=1,this.Eu()}Eu(){this.a_.Xo((async()=>{const e=new Dl(this.datastore),t=this.du(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Au(e)}))))})).catch((e=>{this.Au(e)}))}))}du(e){try{const t=this.updateFunction(e);return!ke(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Au(e){this.Tu>0&&this.Ru(e)?(this.Tu-=1,this.asyncQueue.enqueueAndForget((()=>(this.Eu(),Promise.resolve())))):this.deferred.reject(e)}Ru(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Bs(t)}return!1}}const Al="FirestoreClient";class Rl{constructor(e,t,n,r,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=h.UNAUTHENTICATED,this.clientId=O.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,(async e=>{p(Al,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(p(Al,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new x;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=wc(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Vl(e,t){e.asyncQueue.verifyOperationInProgress(),p(Al,"Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Qa(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function Ll(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Ml(e);p(Al,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>fc(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>fc(t.remoteStore,n))),e._onlineComponents=t}async function Ml(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){p(Al,"Using user provided OfflineComponentProvider");try{await Vl(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!function(e){return"FirebaseError"===e.name?e.code===E.FAILED_PRECONDITION||e.code===E.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}(n))throw n;w("Error using user provided cache. Falling back to memory cache: "+n),await Vl(e,new _l)}}else p(Al,"Using default OfflineComponentProvider"),await Vl(e,new Tl(void 0));return e._offlineComponents}async function Fl(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(p(Al,"Using user provided OnlineComponentProvider"),await Ll(e,e._uninitializedComponentsProvider._online)):(p(Al,"Using default OnlineComponentProvider"),await Ll(e,new Sl))),e._onlineComponents}function Ol(e){return Ml(e).then((e=>e.persistence))}function Pl(e){return Ml(e).then((e=>e.localStore))}function ql(e){return Fl(e).then((e=>e.remoteStore))}function Ul(e){return Fl(e).then((e=>e.syncEngine))}function Bl(e){return Fl(e).then((e=>e.datastore))}async function zl(e){const t=await Fl(e),n=t.eventManager;return n.onListen=Kc.bind(null,t.syncEngine),n.onUnlisten=Wc.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=Gc.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=Hc.bind(null,t.syncEngine),n}function $l(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Nl({next:a=>{i.su(),t.enqueueAndForget((()=>xc(e,o)));const u=a.docs.has(n);!u&&a.fromCache?s.reject(new S(E.UNAVAILABLE,"Failed to get document because the client is offline.")):u&&a.fromCache&&r&&"server"===r.source?s.reject(new S(E.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(a)},error:e=>s.reject(e)}),o=new Rc(kr(n.path),i,{includeMetadataChanges:!0,Ta:!0});return Sc(e,o)}(await zl(e),e.asyncQueue,t,n,r))),r.promise}function Kl(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Nl({next:n=>{i.su(),t.enqueueAndForget((()=>xc(e,o))),n.fromCache&&"server"===r.source?s.reject(new S(E.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new Rc(n,i,{includeMetadataChanges:!0,Ta:!0});return Sc(e,o)}(await zl(e),e.asyncQueue,t,n,r))),r.promise}function Gl(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?F().encode(e):e,function(e,t){return new kl(e,t)}(function(e,t){if(e instanceof Uint8Array)return xl(e,t);if(e instanceof ArrayBuffer)return xl(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,Au(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=b(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=b(e),r=di(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.Yr.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Fc(r));const s=new Mc(r,e.localStore,t.serializer);let i=await t.Ya();for(;i;){const e=await s.Aa(i);e&&n._updateProgress(e),i=await t.Ya()}const o=await s.complete();return await ul(e,o.ma,void 0),await function(e,t){const n=b(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.Yr.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Va)}catch(e){return w(Uc,`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await Ul(e),s,r)}))}function jl(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Ql=new Map;function Wl(e,t,n){if(!n)throw new S(E.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Hl(e,t,n,r){if(!0===t&&!0===r)throw new S(E.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Yl(e){if(!Z.isDocumentKey(e))throw new S(E.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Zl(e){if(Z.isDocumentKey(e))throw new S(E.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Jl(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":I()}function Xl(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new S(E.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Jl(e);throw new S(E.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function eh(e,t){if(t<=0)throw new S(E.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}const th="firestore.googleapis.com";class nh{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new S(E.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=th,this.ssl=true}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=Fo;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<Zo)throw new S(E.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Hl("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=jl(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new S(E.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new S(E.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new S(E.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class rh{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new nh({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new S(E.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new S(E.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new nh(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new k;switch(e.type){case"firstParty":return new R(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new S(E.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Ql.get(e);t&&(p("ComponentProvider","Removing Datastore"),Ql.delete(e),t.terminate())}(this),Promise.resolve()}}function sh(e,t,n,r={}){var s;const i=(e=Xl(e,rh))._getSettings(),a=`${t}:${n}`;if(i.host!==th&&i.host!==a&&w("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=h.MOCK_USER;else{t=(0,o.Sg)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(E.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new h(i)}e._authCredentials=new D(new N(t,n))}}class ih{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new ih(this.firestore,e,this._query)}}class oh{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ah(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new oh(this.firestore,e,this._key)}}class ah extends ih{constructor(e,t,n){super(e,t,kr(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new oh(this.firestore,null,new Z(e))}withConverter(e){return new ah(this.firestore,e,this._path)}}function uh(e,t,...n){if(e=(0,o.m9)(e),Wl("collection","path",t),e instanceof rh){const r=W.fromString(t,...n);return Zl(r),new ah(e,null,r)}{if(!(e instanceof oh||e instanceof ah))throw new S(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(W.fromString(t,...n));return Zl(r),new ah(e.firestore,null,r)}}function ch(e,t){if(e=Xl(e,rh),Wl("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new S(E.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new ih(e,null,function(e){return new xr(W.emptyPath(),e)}(t))}function lh(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=O.newId()),Wl("doc","path",t),e instanceof rh){const r=W.fromString(t,...n);return Yl(r),new oh(e,null,new Z(r))}{if(!(e instanceof oh||e instanceof ah))throw new S(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(W.fromString(t,...n));return Yl(r),new oh(e.firestore,e instanceof ah?e.converter:null,new Z(r))}}function hh(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),(e instanceof oh||e instanceof ah)&&(t instanceof oh||t instanceof ah)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function dh(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),e instanceof ih&&t instanceof ih&&e.firestore===t.firestore&&Fr(e._query,t._query)&&e.converter===t.converter}const fh="AsyncQueue";class mh{constructor(e=Promise.resolve()){this.Vu=[],this.mu=!1,this.fu=[],this.gu=null,this.pu=!1,this.yu=!1,this.wu=[],this.a_=new Ru(this,"async_queue_retry"),this.Su=()=>{const e=Cu();e&&p(fh,"Visibility state changed to "+e.visibilityState),this.a_.t_()},this.bu=e;const t=Cu();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Su)}get isShuttingDown(){return this.mu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Du(),this.vu(e)}enterRestrictedMode(e){if(!this.mu){this.mu=!0,this.yu=e||!1;const t=Cu();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Su)}}enqueue(e){if(this.Du(),this.mu)return new Promise((()=>{}));const t=new x;return this.vu((()=>this.mu&&this.yu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Vu.push(e),this.Cu())))}async Cu(){if(0!==this.Vu.length){try{await this.Vu[0](),this.Vu.shift(),this.a_.reset()}catch(e){if(!we(e))throw e;p(fh,"Operation failed with retryable error: "+e)}this.Vu.length>0&&this.a_.Xo((()=>this.Cu()))}}vu(e){const t=this.bu.then((()=>(this.pu=!0,e().catch((e=>{this.gu=e,this.pu=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw y("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.pu=!1,e))))));return this.bu=t,t}enqueueAfterDelay(e,t,n){this.Du(),this.wu.indexOf(e)>-1&&(t=0);const r=yc.createAndSchedule(this,e,t,n,(e=>this.Fu(e)));return this.fu.push(r),r}Du(){this.gu&&I()}verifyOperationInProgress(){}async Mu(){let e;do{e=this.bu,await e}while(e!==this.bu)}xu(e){for(const t of this.fu)if(t.timerId===e)return!0;return!1}Ou(e){return this.Mu().then((()=>{this.fu.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.fu)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Mu()}))}Nu(e){this.wu.push(e)}Fu(e){const t=this.fu.indexOf(e);this.fu.splice(t,1)}}function gh(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return!0;return!1}(e,["next","error","complete"])}class ph{constructor(){this._progressObserver={},this._taskCompletionResolver=new x,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const yh=-1;class wh extends rh{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new mh,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new mh(e),this._firestoreClient=void 0,await e}}}function vh(e){if(e._terminated)throw new S(E.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||Ih(e),e._firestoreClient}function Ih(e){var t,n,r;const s=e._freezeSettings(),i=function(e,t,n,r){return new fn(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,jl(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._componentsProvider||(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider}),e._firestoreClient=new Rl(e._authCredentials,e._appCheckCredentials,e._queue,i,e._componentsProvider&&function(e){const t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}function _h(e,t){w("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings();return bh(e,Sl.provider,{build:e=>new bl(e,n.cacheSizeBytes,null==t?void 0:t.forceOwnership)}),Promise.resolve()}async function Th(e){w("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=e._freezeSettings();bh(e,Sl.provider,{build:e=>new El(e,t.cacheSizeBytes)})}function bh(e,t,n){if((e=Xl(e,wh))._firestoreClient||e._terminated)throw new S(E.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new S(E.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},Ih(e)}function Eh(e){if(e._initialized&&!e._terminated)throw new S(E.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new x;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!me.D())return Promise.resolve();const t=e+Ma;await me.delete(t)}(qa(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Sh(e){return function(e){const t=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=b(e);Yu(n.remoteStore)||p(Uc,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=b(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(e===Ne)return void t.resolve();const r=n.Ga.get(e)||[];r.push(t),n.Ga.set(e,r)}catch(e){const n=wc(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await Ul(e),t))),t.promise}(vh(e=Xl(e,wh)))}function xh(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Ol(e),n=await ql(e);return t.setNetworkEnabled(!0),function(e){const t=b(e);return t.W_.delete(0),zu(t)}(n)}))}(vh(e=Xl(e,wh)))}function Nh(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Ol(e),n=await ql(e);return t.setNetworkEnabled(!1),async function(e){const t=b(e);t.W_.add(0),await $u(t),t.j_.set("Offline")}(n)}))}(vh(e=Xl(e,wh)))}function kh(e,t){const n=vh(e=Xl(e,wh)),r=new ph;return Gl(n,e._databaseId,t,r),r}function Dh(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=b(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.Yr.getNamedQuery(e,t)))}(await Pl(e),t)))}(vh(e=Xl(e,wh)),t).then((t=>t?new ih(e,null,t.query):null))}class Ch{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Ch(en.fromBase64String(e))}catch(e){throw new S(E.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Ch(en.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Ah{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new S(E.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Y(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Rh{constructor(e){this._methodName=e}}class Vh{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new S(E.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new S(E.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return P(this._lat,e._lat)||P(this._long,e._long)}}class Lh{constructor(e){this._values=(e||[]).map((e=>e))}toArray(){return this._values.map((e=>e))}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}const Mh=/^__.*__$/;class Fh{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Ds(e,this.data,this.fieldMask,t,this.fieldTransforms):new ks(e,this.data,t,this.fieldTransforms)}}class Oh{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Ds(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Ph(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw I()}}class qh{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Bu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Lu(){return this.settings.Lu}ku(e){return new qh(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}qu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.$u(e),r}Uu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.Bu(),r}Ku(e){return this.ku({path:void 0,Qu:!0})}Wu(e){return id(e,this.settings.methodName,this.settings.Gu||!1,this.path,this.settings.zu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}Bu(){if(this.path)for(let e=0;e<this.path.length;e++)this.$u(this.path.get(e))}$u(e){if(0===e.length)throw this.Wu("Document fields must not be empty");if(Ph(this.Lu)&&Mh.test(e))throw this.Wu('Document fields cannot begin and end with "__"')}}class Uh{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Au(e)}ju(e,t,n,r=!1){return new qh({Lu:e,methodName:t,zu:n,path:Y.emptyPath(),Qu:!1,Gu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Bh(e){const t=e._freezeSettings(),n=Au(e._databaseId);return new Uh(e._databaseId,!!t.ignoreUndefinedProperties,n)}function zh(e,t,n,r,s,i={}){const o=e.ju(i.merge||i.mergeFields?2:0,t,n,s);td("Data must be an object, but it was:",o,r);const a=Xh(r,o);let u,c;if(i.merge)u=new Zt(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=nd(t,r,n);if(!o.contains(s))throw new S(E.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);od(e,s)||e.push(s)}u=new Zt(e),c=o.fieldTransforms.filter((e=>u.covers(e.field)))}else u=null,c=o.fieldTransforms;return new Fh(new Gn(a),u,c)}class $h extends Rh{_toFieldTransform(e){if(2!==e.Lu)throw 1===e.Lu?e.Wu(`${this._methodName}() can only appear at the top level of your update data`):e.Wu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof $h}}function Kh(e,t,n){return new qh({Lu:3,zu:t.settings.zu,methodName:e._methodName,Qu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class Gh extends Rh{_toFieldTransform(e){return new ws(e.path,new ls)}isEqual(e){return e instanceof Gh}}class jh extends Rh{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){const t=Kh(this,e,!0),n=this.Hu.map((e=>Jh(e,t))),r=new hs(n);return new ws(e.path,r)}isEqual(e){return e instanceof jh&&(0,o.vZ)(this.Hu,e.Hu)}}class Qh extends Rh{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){const t=Kh(this,e,!0),n=this.Hu.map((e=>Jh(e,t))),r=new fs(n);return new ws(e.path,r)}isEqual(e){return e instanceof Qh&&(0,o.vZ)(this.Hu,e.Hu)}}class Wh extends Rh{constructor(e,t){super(e),this.Ju=t}_toFieldTransform(e){const t=new gs(e.serializer,is(e.serializer,this.Ju));return new ws(e.path,t)}isEqual(e){return e instanceof Wh&&this.Ju===e.Ju}}function Hh(e,t,n,r){const s=e.ju(1,t,n);td("Data must be an object, but it was:",s,r);const i=[],a=Gn.empty();$t(r,((e,r)=>{const u=sd(t,e,n);r=(0,o.m9)(r);const c=s.Uu(u);if(r instanceof $h)i.push(u);else{const e=Jh(r,c);null!=e&&(i.push(u),a.set(u,e))}}));const u=new Zt(i);return new Oh(a,u,s.fieldTransforms)}function Yh(e,t,n,r,s,i){const a=e.ju(1,t,n),u=[nd(t,r,n)],c=[s];if(i.length%2!=0)throw new S(E.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)u.push(nd(t,i[o])),c.push(i[o+1]);const l=[],h=Gn.empty();for(let f=u.length-1;f>=0;--f)if(!od(l,u[f])){const e=u[f];let t=c[f];t=(0,o.m9)(t);const n=a.Uu(e);if(t instanceof $h)l.push(e);else{const r=Jh(t,n);null!=r&&(l.push(e),h.set(e,r))}}const d=new Zt(l);return new Oh(h,d,a.fieldTransforms)}function Zh(e,t,n,r=!1){return Jh(n,e.ju(r?4:3,t))}function Jh(e,t){if(ed(e=(0,o.m9)(e)))return td("Unsupported field value:",t,e),Xh(e,t);if(e instanceof Rh)return function(e,t){if(!Ph(t.Lu))throw t.Wu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Wu(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Qu&&4!==t.Lu)throw t.Wu("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=Jh(s,t.Ku(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return is(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=K.fromDate(e);return{timestampValue:ci(t.serializer,n)}}if(e instanceof K){const n=new K(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ci(t.serializer,n)}}if(e instanceof Vh)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Ch)return{bytesValue:li(t.serializer,e._byteString)};if(e instanceof oh){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Wu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:fi(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof Lh)return function(e,t){return{mapValue:{fields:{[pn]:{stringValue:vn},[In]:{arrayValue:{values:e.toArray().map((e=>{if("number"!=typeof e)throw t.Wu("VectorValues must only contain numeric values.");return rs(t.serializer,e)}))}}}}}}(e,t);throw t.Wu(`Unsupported field value: ${Jl(e)}`)}(e,t)}function Xh(e,t){const n={};return Kt(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):$t(e,((e,r)=>{const s=Jh(r,t.qu(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function ed(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof K||e instanceof Vh||e instanceof Ch||e instanceof oh||e instanceof Rh||e instanceof Lh)}function td(e,t,n){if(!ed(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Jl(n);throw"an object"===r?t.Wu(e+" a custom object"):t.Wu(e+" "+r)}}function nd(e,t,n){if((t=(0,o.m9)(t))instanceof Ah)return t._internalPath;if("string"==typeof t)return sd(e,t);throw id("Field path arguments must be of type string or ",e,!1,void 0,n)}const rd=new RegExp("[~\\*/\\[\\]]");function sd(e,t,n){if(t.search(rd)>=0)throw id(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Ah(...t.split("."))._internalPath}catch(r){throw id(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function id(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new S(E.INVALID_ARGUMENT,a+e+u)}function od(e,t){return e.some((e=>e.isEqual(t)))}class ad{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new oh(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new ud(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(cd("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class ud extends ad{data(){return super.data()}}function cd(e,t){return"string"==typeof t?sd(e,t):t instanceof Ah?t._internalPath:t._delegate._internalPath}function ld(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new S(E.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class hd{}class dd extends hd{}function fd(e,t,...n){let r=[];t instanceof hd&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof pd)).length,n=e.filter((e=>e instanceof md)).length;if(t>1||t>0&&n>0)throw new S(E.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const s of r)e=s._apply(e);return e}class md extends dd{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new md(e,t,n)}_apply(e){const t=this._parse(e);return Ad(e._query,t),new ih(e.firestore,e.converter,Lr(e._query,t))}_parse(e){const t=Bh(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(E.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Cd(o,i);const t=[];for(const n of o)t.push(Dd(r,e,n));a={arrayValue:{values:t}}}else a=Dd(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Cd(o,i),a=Zh(n,t,o,"in"===i||"not-in"===i);return er.create(s,i,a)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function gd(e,t,n){const r=t,s=cd("where",e);return md._create(s,r,n)}class pd extends hd{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new pd(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:tr.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const s of r)Ad(n,s),n=Lr(n,s)}(e._query,t),new ih(e.firestore,e.converter,Lr(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class yd extends dd{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new yd(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new S(E.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new S(E.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Zn(t,n)}(e._query,this._field,this._direction);return new ih(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new xr(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function wd(e,t="asc"){const n=t,r=cd("orderBy",e);return yd._create(r,n)}class vd extends dd{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new vd(e,t,n)}_apply(e){return new ih(e.firestore,e.converter,Mr(e._query,this._limit,this._limitType))}}function Id(e){return eh("limit",e),vd._create("limit",e,"F")}function _d(e){return eh("limitToLast",e),vd._create("limitToLast",e,"L")}class Td extends dd{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Td(e,t,n)}_apply(e){const t=kd(e,this.type,this._docOrFields,this._inclusive);return new ih(e.firestore,e.converter,function(e,t){return new xr(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function bd(...e){return Td._create("startAt",e,!0)}function Ed(...e){return Td._create("startAfter",e,!1)}class Sd extends dd{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Sd(e,t,n)}_apply(e){const t=kd(e,this.type,this._docOrFields,this._inclusive);return new ih(e.firestore,e.converter,function(e,t){return new xr(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function xd(...e){return Sd._create("endBefore",e,!1)}function Nd(...e){return Sd._create("endAt",e,!0)}function kd(e,t,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof ad)return function(e,t,n,r,s){if(!r)throw new S(E.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of Ar(e))if(o.field.isKeyField())i.push(An(t,r.key));else{const e=r.data.field(o.field);if(ln(e))throw new S(E.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new S(E.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Wn(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=Bh(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new S(E.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let u=0;u<s.length;u++){const i=s[u];if(o[u].field.isKeyField()){if("string"!=typeof i)throw new S(E.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!Cr(e)&&-1!==i.indexOf("/"))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(W.fromString(i));if(!Z.isDocumentKey(n))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new Z(n);a.push(An(t,s))}else{const e=Zh(n,r,i);a.push(e)}}return new Wn(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function Dd(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(E.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Cr(t)&&-1!==n.indexOf("/"))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(W.fromString(n));if(!Z.isDocumentKey(r))throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return An(e,new Z(r))}if(n instanceof oh)return An(e,n._key);throw new S(E.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Jl(n)}.`)}function Cd(e,t){if(!Array.isArray(e)||0===e.length)throw new S(E.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Ad(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new S(E.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new S(E.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class Rd{convertValue(e,t="none"){switch(Tn(e)){case 0:return null;case 1:return e.booleanValue;case 2:return rn(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(sn(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw I()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return $t(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertVectorValue(e){var t,n,r;const s=null===(r=null===(n=null===(t=e.fields)||void 0===t?void 0:t[In].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map((e=>rn(e.doubleValue)));return new Lh(s)}convertGeoPoint(e){return new Vh(rn(e.latitude),rn(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=hn(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(dn(e));default:return null}}convertTimestamp(e){const t=nn(e);return new K(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=W.fromString(e);_(Oi(n));const r=new gn(n.get(1),n.get(3)),s=new Z(n.popFirst(5));return r.isEqual(t)||y(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Vd(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Ld extends Rd{constructor(e){super(),this.firestore=e}convertBytes(e){return new Ch(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new oh(this.firestore,null,t)}}class Md{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Fd extends ad{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Od(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(cd("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Od extends Fd{data(e={}){return super.data(e)}}class Pd{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Md(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Od(this._firestore,this._userDataWriter,n.key,n,new Md(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new S(E.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new Od(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Md(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Od(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Md(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:qd(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function qd(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return I()}}function Ud(e,t){return e instanceof Fd&&t instanceof Fd?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Pd&&t instanceof Pd&&e._firestore===t._firestore&&dh(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Bd(e){e=Xl(e,oh);const t=Xl(e.firestore,wh);return $l(vh(t),e._key).then((n=>tf(t,e,n)))}class zd extends Rd{constructor(e){super(),this.firestore=e}convertBytes(e){return new Ch(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new oh(this.firestore,null,t)}}function $d(e){e=Xl(e,oh);const t=Xl(e.firestore,wh),n=vh(t),r=new zd(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=b(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(E.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=wc(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Pl(e),t,n))),n.promise}(n,e._key).then((n=>new Fd(t,r,e._key,n,new Md(null!==n&&n.hasLocalMutations,!0),e.converter)))}function Kd(e){e=Xl(e,oh);const t=Xl(e.firestore,wh);return $l(vh(t),e._key,{source:"server"}).then((n=>tf(t,e,n)))}function Gd(e){e=Xl(e,ih);const t=Xl(e.firestore,wh),n=vh(t),r=new zd(t);return ld(e._query),Kl(n,e._query).then((n=>new Pd(t,r,e,n)))}function jd(e){e=Xl(e,ih);const t=Xl(e.firestore,wh),n=vh(t),r=new zd(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Xa(e,t,!0),s=new qc(t,r.gs),i=s.ba(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=wc(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Pl(e),t,n))),n.promise}(n,e._query).then((n=>new Pd(t,r,e,n)))}function Qd(e){e=Xl(e,ih);const t=Xl(e.firestore,wh),n=vh(t),r=new zd(t);return Kl(n,e._query,{source:"server"}).then((n=>new Pd(t,r,e,n)))}function Wd(e,t,n){e=Xl(e,oh);const r=Xl(e.firestore,wh),s=Vd(e.converter,t,n);return ef(r,[zh(Bh(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,Is.none())])}function Hd(e,t,n,...r){e=Xl(e,oh);const s=Xl(e.firestore,wh),i=Bh(s);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof Ah?Yh(i,"updateDoc",e._key,t,n,r):Hh(i,"updateDoc",e._key,t),ef(s,[a.toMutation(e._key,Is.exists(!0))])}function Yd(e){return ef(Xl(e.firestore,wh),[new Vs(e._key,Is.none())])}function Zd(e,t){const n=Xl(e.firestore,wh),r=lh(e),s=Vd(e.converter,t);return ef(n,[zh(Bh(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,Is.exists(!1))]).then((()=>r))}function Jd(e,...t){var n,r,s;e=(0,o.m9)(e);let i={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[a]||gh(t[a])||(i=t[a],a++);const u={includeMetadataChanges:i.includeMetadataChanges,source:i.source};if(gh(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let c,l,h;if(e instanceof oh)l=Xl(e.firestore,wh),h=kr(e._key.path),c={next:n=>{t[a]&&t[a](tf(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=Xl(e,ih);l=Xl(n.firestore,wh),h=n._query;const r=new zd(l);c={next:e=>{t[a]&&t[a](new Pd(l,r,n,e))},error:t[a+1],complete:t[a+2]},ld(e._query)}return function(e,t,n,r){const s=new Nl(r),i=new Rc(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>Sc(await zl(e),i))),()=>{s.su(),e.asyncQueue.enqueueAndForget((async()=>xc(await zl(e),i)))}}(vh(l),h,u,c)}function Xd(e,t){return function(e,t){const n=new Nl(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).ia.add(t),t.next()}(await zl(e),n))),()=>{n.su(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).ia.delete(t)}(await zl(e),n)))}}(vh(e=Xl(e,wh)),gh(t)?t:{next:t})}function ef(e,t){return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Il(e);try{const e=await function(e,t){const n=b(e),r=K.now(),s=t.reduce(((e,t)=>e.add(t.key)),es());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Gr(),u=es();return n.ds.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(u=u.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=xs(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new Ds(e.key,t,jn(t.value.mapValue),Is.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Wr(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Wa[e.currentUser.toKey()];r||(r=new Gt(P)),r=r.insert(t,n),e.Wa[e.currentUser.toKey()]=r}(r,e.batchId,n),await ul(r,e.changes),await sc(r.remoteStore)}catch(e){const t=wc(e,"Failed to persist write");n.reject(t)}}(await Ul(e),t,n))),n.promise}(vh(e),t)}function tf(e,t,n){const r=n.docs.get(t._key),s=new zd(e);return new Fd(e,s,t._key,r,new Md(n.hasPendingWrites,n.fromCache),t.converter)}const nf={maxAttempts:5};class rf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Bh(e)}set(e,t,n){this._verifyNotCommitted();const r=sf(e,this._firestore),s=Vd(r.converter,t,n),i=zh(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Is.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=sf(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof Ah?Yh(this._dataReader,"WriteBatch.update",s._key,t,n,r):Hh(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,Is.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=sf(e,this._firestore);return this._mutations=this._mutations.concat(new Vs(t._key,Is.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(E.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function sf(e,t){if((e=(0,o.m9)(e)).firestore!==t)throw new S(E.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class of{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Bh(e)}get(e){const t=sf(e,this._firestore),n=new Ld(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return I();const r=e[0];if(r.isFoundDocument())return new ad(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new ad(this._firestore,n,t._key,null,t.converter);throw I()}))}set(e,t,n){const r=sf(e,this._firestore),s=Vd(r.converter,t,n),i=zh(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=sf(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof Ah?Yh(this._dataReader,"Transaction.update",s._key,t,n,r):Hh(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=sf(e,this._firestore);return this._transaction.delete(t._key),this}}class af extends of{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=sf(e,this._firestore),n=new zd(this._firestore);return super.get(e).then((e=>new Fd(this._firestore,n,t._key,e._document,new Md(!1,!1),t.converter)))}}function uf(e,t,n){e=Xl(e,wh);const r=Object.assign(Object.assign({},nf),n);return function(e){if(e.maxAttempts<1)throw new S(E.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>{const s=await Bl(e);new Cl(e.asyncQueue,s,n,t,r).Iu()})),r.promise}(vh(e),(n=>t(new af(e,n))),r)}function cf(){return new $h("deleteField")}function lf(){return new Gh("serverTimestamp")}function hf(...e){return new jh("arrayUnion",e)}function df(...e){return new Qh("arrayRemove",e)}function ff(e){return new Wh("increment",e)}new WeakMap;!function(e,t=!0){!function(e){d=e}(r.SDK_VERSION),(0,r._registerComponent)(new s.wA("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new wh(new C(e.getProvider("auth-internal")),new L(s,e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new S(E.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new gn(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),(0,r.registerVersion)(c,l,e),(0,r.registerVersion)(c,l,"esm2017")}()}}]);
//# sourceMappingURL=7112840a-dc7e191d61c8535e6f13.js.map